<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ระบบการจองโรงเรียนสำหรับการแนะแนว</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#eff6ff',
              100: '#dbeafe',
              200: '#bfdbfe',
              300: '#93c5fd',
              400: '#60a5fa',
              500: '#3b82f6',
              600: '#2563eb',
              700: '#1d4ed8',
              800: '#1e40af',
              900: '#1e3a8a',
            }
          },
          fontFamily: {
            sans: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif']
          },
          boxShadow: {
            soft: '0 10px 25px rgba(30,64,175,0.08)'
          }
        }
      }
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    html, body { height: 100%; background: linear-gradient(180deg, #f0f6ff, #ffffff); }
    .glass { background: rgba(255,255,255,0.9); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }
    .card { box-shadow: 0 10px 30px rgba(30,64,175,.08); }
    .tag { border: 1px solid rgba(30,64,175,.15); }
    .fade-enter { opacity: 0; transform: translateY(6px); }
    .fade-enter-active { opacity: 1; transform: translateY(0); transition: all .25s ease; }
  </style>
</head>
<body class="font-sans text-slate-800">
  <div id="app"></div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <!-- Fuse.js for fuzzy search -->
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
  <!-- SheetJS for Excel parsing -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    // --------------------------
    // App State and Utilities
    // --------------------------
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const app = document.getElementById('app');
    const SESSION_KEY = 'booking_school_session_v3';
    // Built-in accounts (ตัวอย่าง)
    const USER_CREDENTIALS = [
      { username: 'Admin', password: 'panyakham888', role: 'admin', firstName: 'Admin', lastName: '' },
      { username: 'panyakham', password: 'pyk8888', role: 'user', firstName: 'ผู้ใช้', lastName: 'ทั่วไป' },
    ];

    const routes = ['login','dashboard','add-school','booking','bookings','users']; // users = admin-only page
    let state = {
      route: 'login',
      user: null,
      schools: {}, // id -> {name, province, level, createdBy, createdAt}
      bookings: {}, // schoolId -> {teacher, datetime, createdAt}
      users: {}, // id -> {username, password, role, firstName, lastName, createdAt}
      loading: true,
      error: ''
    };

    // --------------------------
    // Firebase Init (Realtime DB)
    // --------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyBO98K-HbGieFDLLSORDx8-kiEqjqw4iJQ",
      authDomain: "booking-school.firebaseapp.com",
      databaseURL: "https://booking-school-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "booking-school",
      storageBucket: "booking-school.firebasestorage.app",
      messagingSenderId: "262744641084",
      appId: "1:262744641084:web:253650461d0e4c0f9cfd39",
      measurementId: "G-TN5YE93N4L"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --------------------------
    // Session
    // --------------------------
    function saveSession(user){ localStorage.setItem(SESSION_KEY, JSON.stringify(user)); }
    function loadSession(){ try { const raw = localStorage.getItem(SESSION_KEY); return raw ? JSON.parse(raw) : null; } catch { return null; } }
    function clearSession(){ localStorage.removeItem(SESSION_KEY); }

    // --------------------------
    // Navigation (hashless)
    // --------------------------
    function navigate(route){
      if(!routes.includes(route)) route = 'login';
      if(!state.user && route !== 'login'){ state.route = 'login'; }
      else { state.route = route; }
      render();
    }

    // --------------------------
    // Data syncing
    // --------------------------
    function subscribeData(){
      state.loading = true; render();
      db.ref('schools').on('value', snap => { state.schools = snap.val() || {}; render(); });
      db.ref('bookings').on('value', snap => { state.bookings = snap.val() || {}; render(); });
      db.ref('users').on('value', snap => { state.users = snap.val() || {}; state.loading = false; render(); });
    }

    // Helpers
    function uid(){ return 'id_' + Math.random().toString(36).slice(2,10) + Date.now().toString(36); }
    function fmtDateTime(dtStr){
      if(!dtStr) return '-';
      try { const d = new Date(dtStr); if (isNaN(d.getTime())) return dtStr;
        return d.toLocaleString('th-TH', { dateStyle: 'medium', timeStyle: 'short' }); } catch { return dtStr; }
    }
    function normalizeStr(str){ return (str || '').toString().replace(/\s+/g,' ').trim(); }
    function normKeyNameProvince(name, province){
      return normalizeStr(name).toLowerCase() + '|' + normalizeStr(province).toLowerCase();
    }

    function schoolListArray(){ return Object.entries(state.schools).map(([id, s])=>({ id, ...s })); }
    function bookingListArray(){
      return Object.entries(state.bookings).map(([schoolId, b])=>{
        const s = state.schools[schoolId] || {};
        return { schoolId, schoolName: s.name || '-', province: s.province || '-', level: s.level || '-', teacher: b.teacher, datetime: b.datetime, createdAt: b.createdAt };
      });
    }
    function usersArray(){
      const staticSeeds = USER_CREDENTIALS.map(s => ({ id: 'seed_'+s.username, username: s.username, role: s.role, firstName: s.firstName, lastName: s.lastName, createdAt: '' }));
      const dbUsers = Object.entries(state.users).map(([id,u]) => ({ id, ...u }));
      const map = new Map();
      staticSeeds.forEach(u => map.set(u.username, u));
      dbUsers.forEach(u => map.set(u.username, u)); // DB override seed by username
      return Array.from(map.values());
    }

    // Role helpers
    function isAdmin(){ return state.user && state.user.role === 'admin'; }

    // --------------------------
    // Components
    // --------------------------
    function Layout(content){
      const active = (r) => state.route === r ? 'bg-primary-600 text-white' : 'text-primary-800 hover:bg-primary-100';
      const authed = !!state.user;
      return `
        <header class="glass border-b border-primary-100 sticky top-0 z-20">
          <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-xl bg-white border border-primary-200 flex items-center justify-center overflow-hidden shadow-soft">
                <img src="https://image.makewebeasy.net/makeweb/m_1920x0/CDFbyH4BM/DefaultData/logo_%E0%B8%A1%E0%B8%B9%E0%B8%A5%E0%B8%99%E0%B8%B4%E0%B8%98%E0%B8%B4.png?v=202405291424" alt="โลโก้" class="w-10 h-10 object-contain" onerror="this.src=''; this.alt='Image failed to load'; this.style.display='none';">
              </div>
              <div>
                <h1 class="text-xl sm:text-2xl font-extrabold text-primary-800">ระบบการจองโรงเรียนสำหรับการแนะแนว</h1>
                <p class="text-xs text-primary-700/70">Blue & White • Firebase Realtime Database</p>
              </div>
            </div>
            <nav class="hidden md:flex items-center gap-2">
              ${authed ? `
                <button data-nav="dashboard" class="px-3 py-2 rounded-lg ${active('dashboard')}">Dashboard</button>
                <button data-nav="add-school" class="px-3 py-2 rounded-lg ${active('add-school')}">เพิ่มโรงเรียน</button>
                <button data-nav="booking" class="px-3 py-2 rounded-lg ${active('booking')}">การจองโรงเรียน</button>
                <button data-nav="bookings" class="px-3 py-2 rounded-lg ${active('bookings')}">รายการจอง</button>
                ${isAdmin() ? `<button data-nav="users" class="px-3 py-2 rounded-lg ${active('users')}">ผู้ใช้</button>`:''}
              ` : ''}
            </nav>
            <div class="flex items-center gap-3">
              ${authed ? `
                <span class="hidden sm:inline text-sm text-primary-900/80">
                  ยินดีต้อนรับ, ${state.user.username}
                  <span class="ml-1 px-2 py-0.5 rounded tag text-xs ${isAdmin()?'bg-primary-600 text-white border-transparent':'bg-white text-primary-700'}">
                    ${isAdmin()?'Admin':'User'}
                  </span>
                </span>
                <button id="logoutBtn" class="bg-white text-primary-700 border border-primary-200 hover:bg-primary-50 px-3 py-2 rounded-lg">ออกจากระบบ</button>
              ` : `
                <button data-nav="login" class="bg-primary-600 hover:bg-primary-700 text-white px-3 py-2 rounded-lg">เข้าสู่ระบบ</button>
              `}
            </div>
          </div>
          ${authed ? `
          <div class="md:hidden px-4 pb-3 flex gap-2">
            <button data-nav="dashboard" class="flex-1 px-3 py-2 rounded-lg ${active('dashboard')}">Dashboard</button>
            <button data-nav="add-school" class="flex-1 px-3 py-2 rounded-lg ${active('add-school')}">เพิ่ม</button>
            <button data-nav="booking" class="flex-1 px-3 py-2 rounded-lg ${active('booking')}">จอง</button>
            <button data-nav="bookings" class="flex-1 px-3 py-2 rounded-lg ${active('bookings')}">รายการ</button>
            ${isAdmin()?`<button data-nav="users" class="flex-1 px-3 py-2 rounded-lg ${active('users')}">ผู้ใช้</button>`:''}
          </div>`:''}
        </header>
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
          ${content}
        </main>
        <footer class="py-8 text-center text-sm text-primary-900/60">
          © ${new Date().getFullYear()} ระบบการจองโรงเรียน • สร้างด้วย Firebase Realtime Database
        </footer>
      `;
    }

    function LoginPage(){
      return `
        <section class="min-h-[70vh] flex items-center justify-center">
          <div class="glass card max-w-md w-full rounded-2xl p-8">
            <h2 class="text-2xl font-bold text-primary-800 mb-2">เข้าสู่ระบบ</h2>
            <p class="text-sm text-slate-600 mb-6">กรุณาเข้าสู่ระบบเพื่อใช้งานระบบทั้งหมด</p>
            ${state.error ? `<div class="mb-4 p-3 rounded-lg bg-red-50 text-red-700">${state.error}</div>`:''}
            <form id="loginForm" class="space-y-4">
              <div>
                <label class="block text-sm mb-1 text-slate-700">ชื่อผู้ใช้</label>
                <input required name="username" class="w-full border border-primary-200 rounded-lg px-3 py-2" placeholder="panyakham หรือ Admin"/>
              </div>
              <div>
                <label class="block text-sm mb-1 text-slate-700">รหัสผ่าน</label>
                <input required name="password" type="password" class="w-full border border-primary-200 rounded-lg px-3 py-2" placeholder="••••••••"/>
              </div>
              <button class="w-full bg-primary-600 hover:bg-primary-700 text-white rounded-lg py-2.5 font-semibold">เข้าสู่ระบบ</button>
            </form>
            <div class="mt-4 text-xs text-slate-500">
              ผู้ดูแล: Admin / panyakham888 • ผู้ใช้ทั่วไป: panyakham / pyk8888
            </div>
          </div>
        </section>
      `;
    }

    function Dashboard(){
      const total = Object.keys(state.schools).length;
      const booked = Object.keys(state.bookings).length;
      const available = Math.max(total - booked, 0);
      const bookedCards = bookingListArray()
        .sort((a,b)=> (new Date(b.datetime||0)) - (new Date(a.datetime||0)))
        .slice(0,9)
        .map(r => `
          <div class="border border-primary-100 rounded-xl p-4 bg-white">
            <div class="font-semibold text-primary-900">${r.schoolName}</div>
            <div class="text-sm text-slate-600 mt-1">จังหวัด: ${r.province}</div>
            <div class="text-sm text-slate-600 mt-1">ชั้น: ${r.level || '-'}</div>
            <div class="text-sm text-slate-700 mt-1">ผู้จอง: <span class="font-medium">${r.teacher}</span> • ${fmtDateTime(r.datetime)}</div>
          </div>
        `).join('');

      return `
        <section class="space-y-6">
          <div class="grid md:grid-cols-3 gap-4">
            <div class="glass card rounded-2xl p-6">
              <div class="text-slate-500 text-sm">โรงเรียนทั้งหมด</div>
              <div class="text-4xl font-extrabold text-primary-700 mt-2">${total}</div>
            </div>
            <div class="glass card rounded-2xl p-6">
              <div class="text-slate-500 text-sm">ถูกจองแล้ว</div>
              <div class="text-4xl font-extrabold text-primary-700 mt-2">${booked}</div>
            </div>
            <div class="glass card rounded-2xl p-6">
              <div class="text-slate-500 text-sm">ยังว่าง</div>
              <div class="text-4xl font-extrabold text-primary-700 mt-2">${available}</div>
            </div>
          </div>

          <div class="glass card rounded-2xl p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-semibold text-primary-800">โรงเรียนที่จองล่าสุด</h3>
              <button data-nav="bookings" class="text-primary-700 hover:underline">ดูทั้งหมด</button>
            </div>
            <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3">
              ${bookedCards || `<div class="text-slate-500">ยังไม่มีการจอง</div>`}
            </div>
          </div>
        </section>
      `;
    }

    function UsersPage(){
      if(!isAdmin()) return `<section class="min-h-[50vh] flex items-center justify-center"><div class="text-slate-500">หน้านี้สำหรับผู้ดูแลระบบเท่านั้น</div></section>`;
      return `
        <section class="space-y-6">
          <div class="glass card rounded-2xl p-6">
            <div class="flex items-center justify-between mb-4 gap-2">
              <h3 class="text-xl font-bold text-primary-800">ผู้ใช้</h3>
            </div>
            <form id="addUserForm" class="grid sm:grid-cols-2 lg:grid-cols-6 gap-3">
              <input name="username" required placeholder="ชื่อผู้ใช้" class="border border-primary-200 rounded-lg px-3 py-2">
              <input name="password" required placeholder="รหัสผ่าน" class="border border-primary-200 rounded-lg px-3 py-2" type="password">
              <input name="firstName" required placeholder="ชื่อ" class="border border-primary-200 rounded-lg px-3 py-2">
              <input name="lastName" required placeholder="นามสกุล" class="border border-primary-200 rounded-lg px-3 py-2">
              <select name="role" class="border border-primary-200 rounded-lg px-3 py-2">
                <option value="user">User</option>
                <option value="admin">Admin</option>
              </select>
              <button class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg">เพิ่มผู้ใช้</button>
              <span id="addUserMsg" class="text-sm text-slate-600 lg:col-span-6"></span>
            </form>
          </div>

          <div class="glass card rounded-2xl p-6">
            <div class="flex items-center justify-between mb-3 gap-2">
              <h4 class="text-lg font-semibold text-primary-800">รายการผู้ใช้</h4>
              <input id="userSearch" class="w-64 max-w-full border border-primary-200 rounded-lg px-3 py-2" placeholder="ค้นหาชื่อหรือผู้ใช้...">
            </div>
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-3" id="userList">
              ${usersArray().map(u => `
                <div class="border border-primary-100 rounded-xl p-4 bg-white" data-user-id="${u.id}">
                  <div class="font-semibold text-primary-900">${u.firstName || ''} ${u.lastName || ''} <span class="text-xs text-slate-500">(${u.username})</span></div>
                  <div class="text-sm text-slate-600 mt-1">สิทธิ์: ${u.role==='admin'?'Admin':'User'}</div>
                  ${u.id.startsWith('seed_') ? `<div class="text-xs text-slate-400 mt-2">บัญชีตัวอย่าง (แก้ไข/ลบไม่ได้)</div>` : `
                  <div class="flex items-center gap-2 mt-3">
                    <button class="editUser bg-white text-primary-700 border border-primary-200 hover:bg-primary-50 px-3 py-1.5 rounded-lg" data-id="${u.id}">แก้ไข</button>
                    <button class="deleteUser bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded-lg" data-id="${u.id}">ลบ</button>
                  </div>`}
                </div>
              `).join('')}
            </div>
          </div>
        </section>
      `;
    }

    function AddSchoolPage(){
      return `
        <section class="space-y-6">
          <div class="glass card rounded-2xl p-6">
            <h3 class="text-xl font-bold text-primary-800 mb-1">เพิ่มโรงเรียนใหม่</h3>
            <p class="text-xs text-slate-600 mb-3">ผู้ใช้ทั่วไปสามารถเพิ่มและแก้ไขข้อมูลโรงเรียนที่ตนเองเพิ่ม แต่ไม่สามารถลบได้</p>
            <form id="schoolForm" class="grid md:grid-cols-2 gap-4">
              <div class="md:col-span-2">
                <label class="block text-sm mb-1 text-slate-700">ชื่อโรงเรียน</label>
                <input required name="name" class="w-full border border-primary-200 rounded-lg px-3 py-2">
              </div>
              <div>
                <label class="block text-sm mb-1 text-slate-700">จังหวัด</label>
                <input required name="province" class="w-full border border-primary-200 rounded-lg px-3 py-2">
              </div>
              <div>
                <label class="block text-sm mb-1 text-slate-700">ชั้น</label>
                <input required name="level" class="w-full border border-primary-200 rounded-lg px-3 py-2" placeholder="พิมพ์ชั้นได้เอง เช่น ม.4-ม.6">
              </div>
              <div class="md:col-span-2">
                <label class="block text-sm mb-1 text-slate-700">ข้อมูลผู้เพิ่ม (ไม่บังคับ)</label>
                <input name="createdBy" class="w-full border border-primary-200 rounded-lg px-3 py-2" placeholder="เช่น ครูเอ">
              </div>
              <div class="md:col-span-2 flex items-center gap-3">
                <button class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg">เพิ่มโรงเรียน</button>
                <span id="schoolFormMsg" class="text-sm text-slate-600"></span>
              </div>
            </form>
          </div>

          <div class="glass card rounded-2xl p-6">
            <h3 class="text-xl font-bold text-primary-800 mb-4">อัปโหลดรายชื่อโรงเรียนจาก Excel (.xlsx)</h3>
            <div class="flex flex-col sm:flex-row gap-3 sm:items-center">
              <input id="excelInput" type="file" accept=".xlsx" class="w-full sm:w-auto border border-primary-200 rounded-lg px-3 py-2 bg-white">
              <button id="importBtn" class="bg-white text-primary-700 border border-primary-200 hover:bg-primary-50 px-4 py-2 rounded-lg">นำเข้า</button>
              <span id="importMsg" class="text-sm text-slate-600"></span>
            </div>
            <p class="text-xs text-slate-500 mt-3">คอลัมน์ที่รองรับ: name, province, level (หรือ "ชั้น"), createdBy</p>
          </div>

          <div class="glass card rounded-2xl p-6">
            <div class="flex items-center justify-between mb-3 gap-2">
              <h3 class="text-lg font-semibold text-primary-800">รายการโรงเรียน</h3>
              <input id="schoolSearch" class="w-64 max-w-full border border-primary-200 rounded-lg px-3 py-2" placeholder="ค้นหาโรงเรียน...">
            </div>
            <div id="schoolTable" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
            <div id="schoolEmpty" class="text-slate-500 hidden">ยังไม่มีข้อมูล</div>
          </div>
        </section>
      `;
    }

    function BookingPage(){
      const provinces = Array.from(new Set(schoolListArray().map(s=>s.province).filter(Boolean))).sort((a,b)=>a.localeCompare(b,'th'));
      return `
        <section class="space-y-6">
          <div class="glass card rounded-2xl p-6">
            <h3 class="text-xl font-bold text-primary-800 mb-4">การจองโรงเรียน</h3>
            <div class="grid md:grid-cols-3 gap-3">
              <div class="md:col-span-2">
                <input id="searchInput" class="w-full border border-primary-200 rounded-lg px-4 py-2" placeholder="ค้นหาโรงเรียนหรือจังหวัด...">
              </div>
              <div>
                <select id="provinceFilter" class="w-full border border-primary-200 rounded-lg px-4 py-2">
                  <option value="">ทุกจังหวัด</option>
                  ${provinces.map(p=>`<option>${p}</option>`).join('')}
                </select>
              </div>
            </div>
          </div>

          <div class="glass card rounded-2xl p-6">
            <div id="schoolList" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            <div id="noResults" class="hidden text-center text-slate-500 py-8">ไม่พบโรงเรียนที่ค้นหา</div>
          </div>
        </section>
      `;
    }

    function BookingsListPage(){
      const list = bookingListArray().sort((a,b)=> (new Date(b.datetime||0)) - (new Date(a.datetime||0)));
      return `
        <section class="space-y-6">
          <div class="glass card rounded-2xl p-6">
            <div class="flex items-center justify-between gap-3">
              <h3 class="text-xl font-bold text-primary-800">รายการจองทั้งหมด</h3>
              <input id="bookingSearch" class="w-64 max-w-full border border-primary-200 rounded-lg px-3 py-2" placeholder="ค้นหาโรงเรียน...">
            </div>
          </div>
          <div class="glass card rounded-2xl p-0 overflow-hidden">
            <div class="divide-y" id="bookingList">
              ${list.length ? list.map(row => BookingRow(row)).join('') : `<div class="p-6 text-slate-500">ยังไม่มีการจอง</div>`}
            </div>
          </div>
        </section>
      `;
    }

    function BookingRow(row){
      return `
        <div class="p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3" data-row data-name="${row.schoolName.toLowerCase()}">
          <div>
            <div class="font-semibold text-primary-900">${row.schoolName}</div>
            <div class="text-sm text-slate-600">จังหวัด: ${row.province}</div>
            <div class="text-sm text-slate-600">ชั้น: ${row.level || '-'}</div>
            <div class="text-sm text-slate-700 mt-1">ผู้จอง: <span class="font-medium">${row.teacher}</span> • ${fmtDateTime(row.datetime)}</div>
          </div>
          <div class="flex items-center gap-2">
            ${isAdmin() ? `
            <button class="editBooking bg-white text-primary-700 border border-primary-200 hover:bg-primary-50 px-3 py-1.5 rounded-lg" data-id="${row.schoolId}">แก้ไข</button>
            <button class="deleteBooking bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded-lg" data-id="${row.schoolId}">ลบ</button>
            `:''}
          </div>
        </div>
      `;
    }

    // --------------------------
    // Render
    // --------------------------
    function render(){
      if(!state.user){ state.route = 'login'; }
      const body = state.route === 'login' ? LoginPage()
                 : state.route === 'dashboard' ? Dashboard()
                 : state.route === 'add-school' ? AddSchoolPage()
                 : state.route === 'booking' ? BookingPage()
                 : state.route === 'bookings' ? BookingsListPage()
                 : state.route === 'users' ? UsersPage()
                 : LoginPage();

      app.innerHTML = Layout(`
        ${state.loading ? `<div class="mb-4 p-3 rounded-lg bg-primary-50 text-primary-800">กำลังโหลดข้อมูล...</div>`:''}
        ${body}
      `);

      // Nav
      $$('[data-nav]').forEach(btn=>{
        btn.addEventListener('click', (e)=> { e.preventDefault(); navigate(btn.getAttribute('data-nav')); });
      });

      // Logout
      const logoutBtn = $('#logoutBtn');
      if(logoutBtn){
        logoutBtn.addEventListener('click', (e)=>{
          e.preventDefault();
          clearSession();
          state.user = null;
          navigate('login');
        });
      }

      // Route handlers
      if(state.route === 'login'){
        const form = $('#loginForm');
        form.addEventListener('submit', (e)=>{
          e.preventDefault();
          const data = Object.fromEntries(new FormData(form).entries());
          const dbUser = Object.values(state.users||{}).find(u => u.username === data.username && u.password === data.password);
          let account = null;
          if(dbUser){
            account = { username: dbUser.username, role: dbUser.role, firstName: dbUser.firstName, lastName: dbUser.lastName };
          } else {
            const seed = USER_CREDENTIALS.find(u=> u.username === data.username && u.password === data.password);
            if(seed){ account = { username: seed.username, role: seed.role, firstName: seed.firstName, lastName: seed.lastName }; }
          }
          if(account){
            state.user = { ...account, loggedInAt: Date.now() };
            saveSession(state.user);
            state.error = '';
            subscribeData();
            navigate('dashboard');
          } else {
            state.error = 'ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง';
            render();
          }
        });
      }

      if(state.route === 'users' && isAdmin()){
        const addUserForm = $('#addUserForm');
        addUserForm.addEventListener('submit', async (e)=>{
          e.preventDefault();
          const f = Object.fromEntries(new FormData(addUserForm).entries());
          const username = normalizeStr(f.username);
          const exists = usersArray().some(u => u.username === username);
          const msg = $('#addUserMsg');
          if(exists){ msg.textContent = 'มีผู้ใช้นี้อยู่แล้ว'; return; }
          const id = uid();
          await db.ref('users/'+id).set({
            username,
            password: f.password,
            role: f.role, // 'user' | 'admin'
            firstName: normalizeStr(f.firstName),
            lastName: normalizeStr(f.lastName),
            createdAt: new Date().toISOString()
          });
          addUserForm.reset();
          msg.textContent = 'เพิ่มผู้ใช้เรียบร้อย';
          setTimeout(()=> msg.textContent='', 2000);
        });

        // Search + actions
        const userSearch = $('#userSearch');
        const userListEl = $('#userList');
        function renderUserCards(){
          const q = (userSearch?.value || '').toLowerCase();
          const list = usersArray().filter(u=> !q || `${(u.firstName||'').toLowerCase()} ${(u.lastName||'').toLowerCase()} ${u.username.toLowerCase()}`.includes(q));
          userListEl.innerHTML = list.map(u => `
            <div class="border border-primary-100 rounded-xl p-4 bg-white" data-user-id="${u.id}">
              <div class="font-semibold text-primary-900">${u.firstName || ''} ${u.lastName || ''} <span class="text-xs text-slate-500">(${u.username})</span></div>
              <div class="text-sm text-slate-600 mt-1">สิทธิ์: ${u.role==='admin'?'Admin':'User'}</div>
              ${u.id.startsWith('seed_') ? `<div class="text-xs text-slate-400 mt-2">บัญชีตัวอย่าง (แก้ไข/ลบไม่ได้)</div>` : `
              <div class="flex items-center gap-2 mt-3">
                <button class="editUser bg-white text-primary-700 border border-primary-200 hover:bg-primary-50 px-3 py-1.5 rounded-lg" data-id="${u.id}">แก้ไข</button>
                <button class="deleteUser bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded-lg" data-id="${u.id}">ลบ</button>
              </div>`}
            </div>
          `).join('');

          $$('.editUser', userListEl).forEach(btn=> btn.addEventListener('click', ()=> openEditUserModal(btn.getAttribute('data-id'))));
          $$('.deleteUser', userListEl).forEach(btn=> btn.addEventListener('click', ()=> openDeleteUserModal(btn.getAttribute('data-id'))));
        }
        if(userSearch){ userSearch.addEventListener('input', renderUserCards); }
        if(userListEl){ renderUserCards(); }
      }

      if(state.route === 'add-school'){
        const form = $('#schoolForm');
        form.addEventListener('submit', async (e)=>{
          e.preventDefault();
          const f = Object.fromEntries(new FormData(form).entries());
          const name = normalizeStr(f.name);
          const province = normalizeStr(f.province);
          const level = normalizeStr(f.level);
          const existingKeySet = new Set(schoolListArray().map(s => normKeyNameProvince(s.name, s.province)));
          if(existingKeySet.has(normKeyNameProvince(name, province))){
            $('#schoolFormMsg').textContent = 'มีโรงเรียนนี้ในระบบแล้ว (ชื่อ+จังหวัดซ้ำ)';
            return;
          }
          const id = uid();
          const record = {
            name,
            province,
            level,
            createdBy: normalizeStr(f.createdBy||state.user.username||''),
            createdAt: new Date().toISOString()
          };
          await db.ref('schools/'+id).set(record);
          form.reset();
          const msg = $('#schoolFormMsg'); msg.textContent = 'เพิ่มโรงเรียนเรียบร้อย'; setTimeout(()=> msg.textContent='', 2000);
        });

        // Excel import with de-dup and level mapping (accepts "level" or "ชั้น")
        const input = $('#excelInput');
        const importBtn = $('#importBtn');
        importBtn.addEventListener('click', async ()=>{
          const msg = $('#importMsg');
          if(!input.files || !input.files[0]) { msg.textContent = 'กรุณาเลือกไฟล์ .xlsx'; return; }
          msg.textContent = 'กำลังนำเข้า...';
          try {
            const file = input.files[0];
            const data = await file.arrayBuffer();
            const wb = XLSX.read(data, {type:'array'});
            const sheet = wb.Sheets[wb.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(sheet); // [{name, province, level OR ชั้น, createdBy}]
            const existingKeySet = new Set(schoolListArray().map(s => normKeyNameProvince(s.name, s.province)));
            const updates = {};
            let added = 0, skipped = 0;
            rows.slice(0, 1000).forEach(r=>{
              const name = normalizeStr(r.name);
              const province = normalizeStr(r.province);
              const level = normalizeStr(r.level || r['ชั้น'] || '');
              if(!name || !province || !level) { skipped++; return; }
              const key = normKeyNameProvince(name, province);
              if(existingKeySet.has(key)){ skipped++; return; }
              existingKeySet.add(key);
              const id = uid();
              updates[id] = {
                name, province, level,
                createdBy: normalizeStr(r.createdBy || state.user.username || ''),
                createdAt: new Date().toISOString()
              };
              added++;
            });
            if(Object.keys(updates).length){ await db.ref('schools').update(updates); }
            msg.textContent = `นำเข้าเรียบร้อย: เพิ่มใหม่ ${added} แถว, ข้าม ${skipped} แถว (ซ้ำ/ข้อมูลไม่ครบ)`;
            setTimeout(()=> msg.textContent='', 4000);
            input.value = '';
          } catch (err){
            console.error(err);
            msg.textContent = 'ไฟล์ไม่ถูกต้อง หรือนำเข้าไม่สำเร็จ';
          }
        });

        // Render editable school cards
        const listEl = $('#schoolTable');
        const emptyEl = $('#schoolEmpty');
        const searchEl = $('#schoolSearch');
        function renderSchools(){
          const q = (searchEl.value||'').toLowerCase();
          const items = schoolListArray()
            .filter(s=> !q || (s.name||'').toLowerCase().includes(q))
            .sort((a,b)=> a.name.localeCompare(b.name,'th'));
          listEl.innerHTML = items.map(s=>{
            const canEdit = isAdmin() || (s.createdBy && s.createdBy===state.user.username);
            const canDelete = isAdmin();
            return `
              <div class="border border-primary-100 rounded-xl p-4 bg-white">
                <div class="font-semibold text-primary-900">${s.name}</div>
                <div class="text-sm text-slate-600 mt-1">จังหวัด: ${s.province} • ชั้น: ${s.level}</div>
                ${s.createdBy ? `<div class="text-xs text-slate-500 mt-1">เพิ่มโดย: ${s.createdBy}</div>`:''}
                <div class="flex items-center gap-2 mt-3">
                  ${canEdit ? `<button class="editSchool bg-white text-primary-700 border border-primary-200 hover:bg-primary-50 px-3 py-1.5 rounded-lg" data-id="${s.id}">แก้ไข</button>`:''}
                  ${canDelete ? `<button class="deleteSchool bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded-lg" data-id="${s.id}">ลบ</button>`:''}
                </div>
              </div>
            `;
          }).join('');
          emptyEl.classList.toggle('hidden', items.length>0);

          $$('.editSchool', listEl).forEach(btn=> btn.addEventListener('click', ()=> openEditSchool(btn.getAttribute('data-id'))));
          $$('.deleteSchool', listEl).forEach(btn=> btn.addEventListener('click', ()=> openDeleteSchool(btn.getAttribute('data-id'))));
        }
        searchEl.addEventListener('input', renderSchools);
        renderSchools();
      }

      if(state.route === 'booking'){
        const searchInput = $('#searchInput');
        const provinceFilter = $('#provinceFilter');
        const schoolListEl = $('#schoolList');
        const noResultsEl = $('#noResults');

        function updateList(){
          // Exclude booked schools
          const list = schoolListArray().filter(s => !state.bookings[s.id]);
          const query = (searchInput.value || '').trim();
          const province = provinceFilter.value || '';

          const options = {
            keys: ['name','province','level'],
            threshold: 0.35,
            ignoreLocation: true,
            includeScore: true,
            minMatchCharLength: 2
          };

          let filtered = list;
          if(query){
            const fuse = new Fuse(list.map(s=>({
              ...s,
              name: normalizeStr((s.name||'').replace(/\s+/g,' ')),
              province: normalizeStr(s.province||''),
              level: normalizeStr(s.level||'')
            })), options);
            filtered = fuse.search(normalizeStr(query)).map(r=>r.item);
          }

          if(province){
            filtered = filtered.filter(s=> (s.province||'') === province);
          }

          schoolListEl.innerHTML = filtered.slice(0, 60).map(s=>{
            return `
              <div class="border border-primary-100 rounded-xl p-4 bg-white fade-enter">
                <div class="flex items-start justify-between gap-2">
                  <div>
                    <div class="font-semibold text-primary-900">${s.name}</div>
                    <div class="text-sm text-slate-600 mt-1">จังหวัด: ${s.province} • ชั้น: ${s.level}</div>
                  </div>
                  <span class="tag text-xs text-green-700 bg-green-50 px-2 py-1 rounded">ว่าง</span>
                </div>
                <form class="bookingForm mt-3 space-y-2" data-id="${s.id}">
                  <div>
                    <label class="block text-xs text-slate-600 mb-1">ชื่ออาจารย์ผู้จอง</label>
                    <input name="teacher" required class="w-full border border-primary-200 rounded-lg px-3 py-2">
                  </div>
                  <div>
                    <label class="block text-xs text-slate-600 mb-1">วัน เวลา</label>
                    <input name="datetime" type="datetime-local" required class="w-full border border-primary-200 rounded-lg px-3 py-2">
                  </div>
                  <button class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg">จองโรงเรียนนี้</button>
                  <span class="text-sm text-slate-600 formMsg"></span>
                </form>
              </div>
            `;
          }).join('');

          requestAnimationFrame(()=>{
            $$('.fade-enter', schoolListEl).forEach(el=> {
              el.classList.add('fade-enter-active');
              setTimeout(()=> el.classList.remove('fade-enter','fade-enter-active'), 250);
            });
          });

          noResultsEl.classList.toggle('hidden', filtered.length>0);

          // Booking handler
          $$('.bookingForm', schoolListEl).forEach(form=>{
            form.addEventListener('submit', async (e)=>{
              e.preventDefault();
              const id = form.getAttribute('data-id');
              const data = Object.fromEntries(new FormData(form).entries());
              const msg = $('.formMsg', form);
              if(state.bookings[id]){ msg.textContent = 'มีการจองแล้ว'; return; }
              await db.ref('bookings/'+id).set({
                teacher: normalizeStr(data.teacher),
                datetime: data.datetime,
                createdAt: new Date().toISOString()
              });
              form.closest('.border').remove();
              msg.textContent = 'จองสำเร็จ';
              setTimeout(()=> navigate('dashboard'), 400);
            });
          });
        }

        searchInput.addEventListener('input', ()=> updateList());
        provinceFilter.addEventListener('change', ()=> updateList());
        updateList();
      }

      if(state.route === 'bookings'){
        const bookingSearch = $('#bookingSearch');
        const listEl = $('#bookingList');
        function renderRows(){
          const q = (bookingSearch.value || '').toLowerCase();
          const rows = bookingListArray()
            .filter(r=> !q || r.schoolName.toLowerCase().includes(q))
            .sort((a,b)=> (new Date(b.datetime||0)) - (new Date(a.datetime||0)))
            .map(r=> BookingRow(r)).join('');
          listEl.innerHTML = rows || `<div class="p-6 text-slate-500">ไม่พบผลลัพธ์</div>`;

          if(isAdmin()){
            $$('.editBooking', listEl).forEach(btn=>{
              btn.addEventListener('click', ()=> openEditBookingModal(btn.getAttribute('data-id')));
            });
            $$('.deleteBooking', listEl).forEach(btn=>{
              btn.addEventListener('click', ()=> openDeleteBookingModal(btn.getAttribute('data-id')));
            });
          }
        }
        bookingSearch.addEventListener('input', renderRows);
        renderRows();
      }
    }

    // --------------------------
    // Modals (edit / delete) SCHOOLS
    // --------------------------
    function openEditSchool(schoolId){
      const s = state.schools[schoolId];
      const modal = document.createElement('div');
      modal.className = "fixed inset-0 z-40 flex items-center justify-center";
      modal.innerHTML = `
        <div class="absolute inset-0 bg-black/30"></div>
        <div class="relative glass card rounded-2xl p-6 w-[95%] max-w-md z-10">
          <h3 class="text-lg font-bold text-primary-800 mb-2">แก้ไขข้อมูลโรงเรียน</h3>
          <form id="editSchoolForm" class="space-y-3">
            <div>
              <label class="block text-sm mb-1 text-slate-700">ชื่อโรงเรียน</label>
              <input name="name" required class="w-full border border-primary-200 rounded-lg px-3 py-2" value="${s.name}">
            </div>
            <div>
              <label class="block text-sm mb-1 text-slate-700">จังหวัด</label>
              <input name="province" required class="w-full border border-primary-200 rounded-lg px-3 py-2" value="${s.province}">
            </div>
            <div>
              <label class="block text-sm mb-1 text-slate-700">ชั้น</label>
              <input name="level" required class="w-full border border-primary-200 rounded-lg px-3 py-2" value="${s.level || ''}" placeholder="พิมพ์ชั้นได้เอง">
            </div>
            <div class="flex items-center gap-2">
              <button class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg">บันทึก</button>
              <button type="button" id="closeEditSchool" class="bg-white text-primary-700 border border-primary-200 hover:bg-primary-50 px-4 py-2 rounded-lg">ยกเลิก</button>
              <span id="editSchoolMsg" class="text-sm text-slate-600"></span>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);
      $('#closeEditSchool', modal).addEventListener('click', ()=> modal.remove());
      $('#editSchoolForm', modal).addEventListener('submit', async (e)=>{
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target).entries());
        const canEdit = isAdmin() || (s.createdBy && s.createdBy===state.user.username);
        if(!canEdit){ $('#editSchoolMsg', modal).textContent = 'ไม่มีสิทธิ์แก้ไข'; return; }
        await db.ref('schools/'+schoolId).update({
          name: normalizeStr(data.name),
          province: normalizeStr(data.province),
          level: normalizeStr(data.level)
        });
        $('#editSchoolMsg', modal).textContent = 'บันทึกแล้ว';
        setTimeout(()=> modal.remove(), 400);
      });
    }

    function openDeleteSchool(schoolId){
      const s = state.schools[schoolId];
      const modal = document.createElement('div');
      modal.className = "fixed inset-0 z-40 flex items-center justify-center";
      modal.innerHTML = `
        <div class="absolute inset-0 bg-black/30"></div>
        <div class="relative glass card rounded-2xl p-6 w-[95%] max-w-md z-10">
          <h3 class="text-lg font-bold text-red-700 mb-2">ยืนยันการลบโรงเรียน</h3>
          <p class="text-slate-700 mb-4">ลบโรงเรียน <span class="font-semibold">${s.name}</span> ใช่หรือไม่?</p>
          <div class="flex items-center gap-2">
            <button id="confirmDeleteSchool" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">ลบ</button>
            <button id="cancelDeleteSchool" class="bg-white text-primary-700 border border-primary-200 hover:bg-primary-50 px-4 py-2 rounded-lg">ยกเลิก</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      $('#cancelDeleteSchool', modal).addEventListener('click', ()=> modal.remove());
      $('#confirmDeleteSchool', modal).addEventListener('click', async ()=>{
        if(!isAdmin()){ alert('เฉพาะผู้ดูแลระบบเท่านั้นที่ลบได้'); return; }
        await db.ref('schools/'+schoolId).remove();
        if(state.bookings[schoolId]){ await db.ref('bookings/'+schoolId).remove(); }
        modal.remove();
      });
    }

    // --------------------------
    // Modals (edit / delete) BOOKINGS
    // --------------------------
    function openEditBookingModal(schoolId){
      const booking = state.bookings[schoolId];
      const school = state.schools[schoolId] || {};
      const modal = document.createElement('div');
      modal.className = "fixed inset-0 z-40 flex items-center justify-center";
      modal.innerHTML = `
        <div class="absolute inset-0 bg-black/30"></div>
        <div class="relative glass card rounded-2xl p-6 w-[95%] max-w-md z-10">
          <h3 class="text-lg font-bold text-primary-800 mb-2">แก้ไขการจอง</h3>
          <div class="text-sm text-slate-600 mb-4">${school.name || 'โรงเรียน'}</div>
          <form id="editForm" class="space-y-3">
            <div>
              <label class="block text-sm mb-1 text-slate-700">ผู้จอง</label>
              <input name="teacher" required class="w-full border border-primary-200 rounded-lg px-3 py-2" value="${booking ? booking.teacher : ''}">
            </div>
            <div>
              <label class="block text-sm mb-1 text-slate-700">วัน เวลา</label>
              <input name="datetime" type="datetime-local" required class="w-full border border-primary-200 rounded-lg px-3 py-2" value="${booking ? toLocalInput(booking.datetime) : ''}">
            </div>
            <div class="flex items-center gap-2">
              <button class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg">บันทึก</button>
              <button type="button" id="closeEdit" class="bg-white text-primary-700 border border-primary-200 hover:bg-primary-50 px-4 py-2 rounded-lg">ยกเลิก</button>
              <span id="editMsg" class="text-sm text-slate-600"></span>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);

      $('#closeEdit', modal).addEventListener('click', ()=> modal.remove());
      $('#editForm', modal).addEventListener('submit', async (e)=>{
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target).entries());
        await db.ref('bookings/'+schoolId).update({
          teacher: normalizeStr(data.teacher),
          datetime: data.datetime
        });
        $('#editMsg', modal).textContent = 'บันทึกแล้ว';
        setTimeout(()=> modal.remove(), 400);
      });
    }

    function openDeleteBookingModal(schoolId){
      const school = state.schools[schoolId] || {};
      const modal = document.createElement('div');
      modal.className = "fixed inset-0 z-40 flex items-center justify-center";
      modal.innerHTML = `
        <div class="absolute inset-0 bg-black/30"></div>
        <div class="relative glass card rounded-2xl p-6 w-[95%] max-w-md z-10">
          <h3 class="text-lg font-bold text-red-700 mb-2">ยืนยันการลบ</h3>
          <p class="text-slate-700 mb-4">ลบการจองของ <span class="font-semibold">${school.name || 'โรงเรียน'}</span> ใช่หรือไม่?</p>
          <div class="flex items-center gap-2">
            <button id="confirmDelete" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">ลบ</button>
            <button id="cancelDelete" class="bg-white text-primary-700 border border-primary-200 hover:bg-primary-50 px-4 py-2 rounded-lg">ยกเลิก</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      $('#cancelDelete', modal).addEventListener('click', ()=> modal.remove());
      $('#confirmDelete', modal).addEventListener('click', async ()=>{
        await db.ref('bookings/'+schoolId).remove();
        modal.remove();
      });
    }

    // --------------------------
    // Modals (edit / delete) USERS
    // --------------------------
    function openEditUserModal(userId){
      const u = state.users[userId];
      if(!u){ alert('บัญชีตัวอย่างไม่สามารถแก้ไขได้'); return; }
      const modal = document.createElement('div');
      modal.className = "fixed inset-0 z-40 flex items-center justify-center";
      modal.innerHTML = `
        <div class="absolute inset-0 bg-black/30"></div>
        <div class="relative glass card rounded-2xl p-6 w-[95%] max-w-md z-10">
          <h3 class="text-lg font-bold text-primary-800 mb-2">แก้ไขผู้ใช้</h3>
          <p class="text-xs text-slate-600 mb-3">ชื่อผู้ใช้: <span class="font-semibold">${u.username}</span></p>
          <form id="editUserForm" class="space-y-3">
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-sm mb-1 text-slate-700">ชื่อ</label>
                <input name="firstName" class="w-full border border-primary-200 rounded-lg px-3 py-2" value="${u.firstName||''}">
              </div>
              <div>
                <label class="block text-sm mb-1 text-slate-700">นามสกุล</label>
                <input name="lastName" class="w-full border border-primary-200 rounded-lg px-3 py-2" value="${u.lastName||''}">
              </div>
            </div>
            <div>
              <label class="block text-sm mb-1 text-slate-700">สิทธิ์</label>
              <select name="role" class="w-full border border-primary-200 rounded-lg px-3 py-2">
                <option value="user" ${u.role==='user'?'selected':''}>User</option>
                <option value="admin" ${u.role==='admin'?'selected':''}>Admin</option>
              </select>
            </div>
            <div>
              <label class="block text-sm mb-1 text-slate-700">รหัสผ่าน (ถ้าต้องการเปลี่ยน)</label>
              <input name="password" type="password" class="w-full border border-primary-200 rounded-lg px-3 py-2" placeholder="ปล่อยว่างถ้าไม่เปลี่ยน">
            </div>
            <div class="flex items-center gap-2">
              <button class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg">บันทึก</button>
              <button type="button" id="closeEditUser" class="bg-white text-primary-700 border border-primary-200 hover:bg-primary-50 px-4 py-2 rounded-lg">ยกเลิก</button>
              <span id="editUserMsg" class="text-sm text-slate-600"></span>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);
      $('#closeEditUser', modal).addEventListener('click', ()=> modal.remove());
      $('#editUserForm', modal).addEventListener('submit', async (e)=>{
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target).entries());
        const update = {
          firstName: normalizeStr(data.firstName||''),
          lastName: normalizeStr(data.lastName||''),
          role: data.role
        };
        if((data.password||'').trim()){ update.password = data.password; }
        await db.ref('users/'+userId).update(update);
        $('#editUserMsg', modal).textContent = 'บันทึกแล้ว';
        setTimeout(()=> modal.remove(), 400);
      });
    }

    function openDeleteUserModal(userId){
      const u = state.users[userId];
      if(!u){ alert('บัญชีตัวอย่างไม่สามารถลบได้'); return; }
      if(state.user && u.username === state.user.username){
        alert('ไม่สามารถลบบัญชีที่กำลังใช้งานอยู่');
        return;
      }
      const modal = document.createElement('div');
      modal.className = "fixed inset-0 z-40 flex items-center justify-center";
      modal.innerHTML = `
        <div class="absolute inset-0 bg-black/30"></div>
        <div class="relative glass card rounded-2xl p-6 w-[95%] max-w-md z-10">
          <h3 class="text-lg font-bold text-red-700 mb-2">ยืนยันการลบผู้ใช้</h3>
          <p class="text-slate-700 mb-4">ลบผู้ใช้ <span class="font-semibold">${u.firstName||''} ${u.lastName||''} (${u.username})</span> ใช่หรือไม่?</p>
          <div class="flex items-center gap-2">
            <button id="confirmDeleteUser" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">ลบ</button>
            <button id="cancelDeleteUser" class="bg-white text-primary-700 border border-primary-200 hover:bg-primary-50 px-4 py-2 rounded-lg">ยกเลิก</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      $('#cancelDeleteUser', modal).addEventListener('click', ()=> modal.remove());
      $('#confirmDeleteUser', modal).addEventListener('click', async ()=>{
        await db.ref('users/'+userId).remove();
        modal.remove();
      });
    }

    // --------------------------
    // Utils
    // --------------------------
    function toLocalInput(iso){
      try {
        const d = new Date(iso);
        if (isNaN(d.getTime())) return '';
        const pad = n=> String(n).padStart(2,'0');
        const yyyy = d.getFullYear();
        const mm = pad(d.getMonth()+1);
        const dd = pad(d.getDate());
        const hh = pad(d.getHours());
        const mi = pad(d.getMinutes());
        return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
      } catch { return ''; }
    }

    // --------------------------
    // App Boot
    // --------------------------
    (function init(){
      const session = loadSession();
      if(session){
        state.user = session;
        subscribeData();
        navigate('dashboard');
      } else {
        navigate('login');
        subscribeData();
      }
    })();
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98166d8db4182dbc',t:'MTc1ODI1NzA2Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
