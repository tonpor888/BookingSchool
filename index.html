<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ระบบการจองโรงเรียนสำหรับการแนะแนว</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#eef2ff',
              100: '#e0e7ff',
              200: '#c7d2fe',
              300: '#a5b4fc',
              400: '#818cf8',
              500: '#6366f1',
              600: '#4f46e5',
              700: '#4338ca',
              800: '#3730a3',
              900: '#312e81',
            }
          },
          fontFamily: {
            sans: ['Inter','ui-sans-serif','system-ui','-apple-system','Segoe UI','Roboto','Ubuntu','Cantarell','Noto Sans Thai','sans-serif']
          },
          boxShadow: {
            soft: '0 12px 30px rgba(67,56,202,0.12)'
          }
        }
      }
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    html, body { height: 100%; background: radial-gradient(1200px 600px at 10% -10%, #eef2ff 0%, #ffffff 60%); }
    .glass { background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
    .card { box-shadow: 0 10px 30px rgba(67,56,202,.10); }
    .tag { border: 1px solid rgba(67,56,202,.15); }
    .fade-enter { opacity: 0; transform: translateY(6px); }
    .fade-enter-active { opacity: 1; transform: translateY(0); transition: all .25s ease; }
  </style>
</head>
<body class="font-sans text-slate-800">
  <div id="app"></div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <!-- Fuse.js for fuzzy search -->
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
  <!-- SheetJS for Excel parsing -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    // -------------- App State --------------
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const app = document.getElementById('app');
    const SESSION_KEY = 'booking_school_session_v5';

    // Built-in example accounts (non-editable in UI)
    const USER_CREDENTIALS = [
      { username: 'Admin', password: 'panyakham888', role: 'admin', firstName: 'ผู้ดูแล', lastName: 'ระบบ' },
      { username: 'panyakham', password: 'pyk8888', role: 'user', firstName: 'ผู้ใช้', lastName: 'ทั่วไป' },
    ];

    // Routes
    const routes = ['login','dashboard','add-school','booking','my-bookings','bookings','users'];

    let state = {
      route: 'login',
      user: null,
      schools: {},   // id -> {name, province, level, createdBy, createdAt}
      bookings: {},  // schoolId -> [array of {teacher, datetime, createdAt, createdBy}]
      users: {},     // id -> {username, password, role, firstName, lastName, createdAt}
      loading: true,
      error: ''
    };

    // -------------- Firebase Init --------------
    const firebaseConfig = {
      apiKey: "AIzaSyBO98K-HbGieFDLLSORDx8-kiEqjqw4iJQ",
      authDomain: "booking-school.firebaseapp.com",
      databaseURL: "https://booking-school-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "booking-school",
      storageBucket: "booking-school.firebasestorage.app",
      messagingSenderId: "262744641084",
      appId: "1:262744641084:web:253650461d0e4c0f9cfd39",
      measurementId: "G-TN5YE93N4L"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // -------------- Session --------------
    function saveSession(user){ localStorage.setItem(SESSION_KEY, JSON.stringify(user)); }
    function loadSession(){ try { const raw = localStorage.getItem(SESSION_KEY); return raw ? JSON.parse(raw) : null; } catch { return null; } }
    function clearSession(){ localStorage.removeItem(SESSION_KEY); }

    // -------------- Navigation --------------
    function navigate(route){
      if(!routes.includes(route)) route = 'login';
      if(!state.user && route !== 'login') state.route = 'login'; else state.route = route;
      render();
    }

    // -------------- Data Sync --------------
    function subscribeData(){
      state.loading = true; render();
      db.ref('schools').on('value', snap => { state.schools = snap.val() || {}; render(); });
      db.ref('bookings').on('value', snap => { state.bookings = snap.val() || {}; render(); });
      db.ref('users').on('value', snap => { state.users = snap.val() || {}; state.loading = false; render(); });
    }

    // -------------- Helpers --------------
    function uid(){ return 'id_' + Math.random().toString(36).slice(2,10) + Date.now().toString(36); }
    function normalizeStr(str){ return (str || '').toString().replace(/\s+/g,' ').trim(); }
    function displayName(user){
      if(!user) return '';
      const f = normalizeStr(user.firstName||'');
      const l = normalizeStr(user.lastName||'');
      return (f || l) ? `${f}${f&&l?' ':''}${l}` : (user.username || '');
    }
    function fmtDateTime(dtStr){
      if(!dtStr) return '-';
      try {
        const d = new Date(dtStr);
        if (isNaN(d.getTime())) return dtStr;
        return d.toLocaleString('th-TH', { dateStyle: 'medium', timeStyle: 'short' });
      } catch { return dtStr; }
    }
    function normKeyNameProvince(name, province){
      return normalizeStr(name).toLowerCase() + '|' + normalizeStr(province).toLowerCase();
    }
    function schoolListArray(){ return Object.entries(state.schools).map(([id, s])=>({ id, ...s })); }
    function bookingListArray(){
      const result = [];
      Object.entries(state.bookings).forEach(([schoolId, bookingArray])=>{
        const s = state.schools[schoolId] || {};
        if(Array.isArray(bookingArray)){
          bookingArray.forEach(b => {
            result.push({ 
              schoolId, 
              schoolName: s.name || '-', 
              province: s.province || '-', 
              level: s.level || '-', 
              teacher: b.teacher, 
              datetime: b.datetime, 
              createdAt: b.createdAt, 
              createdBy: b.createdBy 
            });
          });
        } else if(bookingArray && typeof bookingArray === 'object') {
          // Handle legacy single booking format
          result.push({ 
            schoolId, 
            schoolName: s.name || '-', 
            province: s.province || '-', 
            level: s.level || '-', 
            teacher: bookingArray.teacher, 
            datetime: bookingArray.datetime, 
            createdAt: bookingArray.createdAt, 
            createdBy: bookingArray.createdBy 
          });
        }
      });
      return result;
    }
    function myBookingListArray(){
      if(!state.user) return [];
      return bookingListArray().filter(b => (b.createdBy || '') === (state.user.username || ''));
    }
    function getSchoolBookings(schoolId){
      const bookings = state.bookings[schoolId];
      if(!bookings) return [];
      if(Array.isArray(bookings)) return bookings;
      if(typeof bookings === 'object') return [bookings]; // Legacy format
      return [];
    }
    function usersArray(){
      const seeds = USER_CREDENTIALS.map(s => ({ id: 'seed_'+s.username, username: s.username, role: s.role, firstName: s.firstName, lastName: s.lastName, createdAt: '' }));
      const dbUsers = Object.entries(state.users).map(([id,u]) => ({ id, ...u }));
      const map = new Map(); // unique by username
      seeds.forEach(u => map.set(u.username, u));
      dbUsers.forEach(u => map.set(u.username, u)); // DB overrides seed
      return Array.from(map.values());
    }
    function isAdmin(){ return state.user && state.user.role === 'admin'; }

    // -------------- UI Components --------------
    function Layout(content){
      const active = (r) => state.route === r ? 'bg-primary-600 text-white' : 'text-primary-800 hover:bg-primary-100';
      const authed = !!state.user;
      return `
        <header class="glass border-b border-primary-100 sticky top-0 z-20">
          <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-xl bg-white border border-primary-200 flex items-center justify-center overflow-hidden shadow-soft">
                <img src="https://image.makewebeasy.net/makeweb/m_1920x0/CDFbyH4BM/DefaultData/logo_%E0%B8%A1%E0%B8%B9%E0%B8%A5%E0%B8%99%E0%B8%B4%E0%B8%98%E0%B8%B4.png?v=202405291424" alt="มูลนิธิเพื่อการศึกษาปัญญาคำ" class="w-8 h-8 object-contain" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <svg viewBox="0 0 48 48" class="w-8 h-8 text-primary-600 hidden" aria-hidden="true">
                  <defs>
                    <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
                      <stop offset="0%" stop-color="#a5b4fc"/>
                      <stop offset="100%" stop-color="#6366f1"/>
                    </linearGradient>
                  </defs>
                  <rect x="8" y="12" width="32" height="24" rx="6" fill="url(#g)"></rect>
                  <path d="M12 20h24M12 28h24" stroke="white" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </div>
              <div>
                <h1 class="text-xl sm:text-2xl font-extrabold text-primary-800">งานแนะแนวการศึกษา</h1>
                <p class="text-xs text-primary-700/70">สำหรับเจ้าหน้าที่</p>
              </div>
            </div>
            <nav class="hidden md:flex items-center gap-2">
              ${authed ? `
                <button data-nav="dashboard" class="px-3 py-2 rounded-lg ${active('dashboard')}">Dashboard</button>
                <button data-nav="add-school" class="px-3 py-2 rounded-lg ${active('add-school')}">เพิ่มโรงเรียน</button>
                <button data-nav="booking" class="px-3 py-2 rounded-lg ${active('booking')}">การจองโรงเรียน</button>
                <button data-nav="my-bookings" class="px-3 py-2 rounded-lg ${active('my-bookings')}">การจองของฉัน</button>
                <button data-nav="bookings" class="px-3 py-2 rounded-lg ${active('bookings')}">รายการจอง</button>
                ${isAdmin() ? `<button data-nav="users" class="px-3 py-2 rounded-lg ${active('users')}">ผู้ใช้</button>`:''}
              ` : ''}
            </nav>
            <div class="flex items-center gap-3">
              ${authed ? `
                <span class="hidden sm:inline text-sm text-primary-900/80">
                  ยินดีต้อนรับ, ${state.user.username}
                  <span class="ml-1 px-2 py-0.5 rounded tag text-xs ${isAdmin()?'bg-primary-600 text-white border-transparent':'bg-white text-primary-700'}">
                    ${isAdmin()?'Admin':'User'}
                  </span>
                </span>
                <button id="logoutBtn" class="bg-white text-primary-700 border border-primary-200 hover:bg-primary-50 px-3 py-2 rounded-lg">ออกจากระบบ</button>
              ` : `
                <button data-nav="login" class="bg-primary-600 hover:bg-primary-700 text-white px-3 py-2 rounded-lg">เข้าสู่ระบบ</button>
              `}
            </div>
          </div>
          ${authed ? `
          <div class="md:hidden px-4 pb-3 flex gap-2 flex-wrap">
            <button data-nav="dashboard" class="px-3 py-2 rounded-lg ${active('dashboard')}">Dashboard</button>
            <button data-nav="add-school" class="px-3 py-2 rounded-lg ${active('add-school')}">เพิ่ม</button>
            <button data-nav="booking" class="px-3 py-2 rounded-lg ${active('booking')}">จอง</button>
            <button data-nav="my-bookings" class="px-3 py-2 rounded-lg ${active('my-bookings')}">ของฉัน</button>
            <button data-nav="bookings" class="px-3 py-2 rounded-lg ${active('bookings')}">รายการ</button>
            ${isAdmin()?`<button data-nav="users" class="px-3 py-2 rounded-lg ${active('users')}">ผู้ใช้</button>`:''}
          </div>`:''}
        </header>
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
          ${content}
        </main>
        <footer class="py-8 text-center text-sm text-primary-900/60">
          © 2025 ระบบการจองโรงเรียน • พัฒนาโดยมูลนิธิเพื่อการศึกษาปัญญาคำ
        </footer>
      `;
    }

    function LoginPage(){
      return `
        <section class="min-h-[70vh] flex items-center justify-center">
          <div class="glass card max-w-md w-full rounded-2xl p-8">
            <h2 class="text-2xl font-extrabold text-primary-800 mb-2">เข้าสู่ระบบ</h2>
            <p class="text-sm text-slate-600 mb-6">กรุณากรอกข้อมูลเพื่อเข้าใช้งานระบบ</p>
            ${state.error ? `<div class="mb-4 p-3 rounded-lg bg-red-50 text-red-700">${state.error}</div>`:''}
            <form id="loginForm" class="space-y-4">
              <div>
                <label class="block text-sm mb-1 text-slate-700">ชื่อผู้ใช้</label>
                <!-- ตามที่ขอ: ให้ช่องนี้ว่างเปล่า -->
                <input required name="username" class="w-full border border-primary-200 rounded-lg px-3 py-2" placeholder="">
              </div>
              <div>
                <label class="block text-sm mb-1 text-slate-700">รหัสผ่าน</label>
                <input required name="password" type="password" class="w-full border border-primary-200 rounded-lg px-3 py-2" placeholder=""/>
              </div>
              <button class="w-full bg-primary-600 hover:bg-primary-700 text-white rounded-lg py-2.5 font-semibold">เข้าสู่ระบบ</button>
            </form>
            <div class="mt-4 text-xs text-slate-500 leading-5">
              ต้องการเปิดบัญชีผู้ใช้กรุณาติดต่อผู้ดูแลระบบ<br>
            </div>
          </div>
        </section>
      `;
    }

    function Dashboard(){
      const total = Object.keys(state.schools).length;
      const schoolsWithBookings = Object.keys(state.bookings).filter(schoolId => {
        const bookings = getSchoolBookings(schoolId);
        return bookings.length > 0;
      }).length;
      const totalBookings = bookingListArray().length;
      const recent = bookingListArray()
        .sort((a,b)=> (new Date(b.datetime||0)) - (new Date(a.datetime||0)))
        .slice(0,9);

      return `
        <section class="space-y-6">
          <div class="grid md:grid-cols-3 gap-4">
            <div class="glass card rounded-2xl p-6">
              <div class="text-slate-500 text-sm">โรงเรียนทั้งหมด</div>
              <div class="text-4xl font-extrabold text-primary-700 mt-2">${total}</div>
            </div>
            <div class="glass card rounded-2xl p-6">
              <div class="text-slate-500 text-sm">โรงเรียนที่มีการจอง</div>
              <div class="text-4xl font-extrabold text-primary-700 mt-2">${schoolsWithBookings}</div>
            </div>
            <div class="glass card rounded-2xl p-6">
              <div class="text-slate-500 text-sm">การจองทั้งหมด</div>
              <div class="text-4xl font-extrabold text-primary-700 mt-2">${totalBookings}</div>
            </div>
          </div>

          <div class="glass card rounded-2xl p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-semibold text-primary-800">โรงเรียนที่จองล่าสุด</h3>
              <button data-nav="bookings" class="text-primary-700 hover:underline">ดูทั้งหมด</button>
            </div>
            <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3">
              ${recent.length ? recent.map(r => `
                <div class="border border-primary-100 rounded-xl p-4 bg-white">
                  <div class="font-semibold text-primary-900">${r.schoolName}</div>
                  <div class="text-sm text-slate-600 mt-1">จังหวัด: ${r.province}</div>
                  <div class="text-sm text-slate-600 mt-1">ชั้น: ${r.level || '-'}</div>
                  <div class="text-sm text-slate-700 mt-1">ผู้จอง: <span class="font-medium">${r.teacher}</span> • ${fmtDateTime(r.datetime)}</div>
                </div>
              `).join('') : `<div class="text-slate-500">ยังไม่มีการจอง</div>`}
            </div>
          </div>
        </section>
      `;
    }

    function UsersPage(){
      if(!isAdmin()) return `<section class="min-h-[50vh] flex items-center justify-center"><div class="text-slate-500">หน้านี้สำหรับผู้ดูแลระบบเท่านั้น</div></section>`;
      const list = usersArray();
      return `
        <section class="space-y-6">
          <div class="glass card rounded-2xl p-6">
            <h3 class="text-xl font-bold text-primary-800 mb-4">ผู้ใช้</h3>
            <form id="addUserForm" class="grid sm:grid-cols-2 lg:grid-cols-6 gap-3">
              <input name="username" required placeholder="ชื่อผู้ใช้" class="border border-primary-200 rounded-lg px-3 py-2">
              <input name="password" required placeholder="รหัสผ่าน" class="border border-primary-200 rounded-lg px-3 py-2" type="password">
              <input name="firstName" required placeholder="ชื่อ" class="border border-primary-200 rounded-lg px-3 py-2">
              <input name="lastName" required placeholder="นามสกุล" class="border border-primary-200 rounded-lg px-3 py-2">
              <select name="role" class="border border-primary-200 rounded-lg px-3 py-2">
                <option value="user">User</option>
                <option value="admin">Admin</option>
              </select>
              <button class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg">เพิ่มผู้ใช้</button>
              <span id="addUserMsg" class="text-sm text-slate-600 lg:col-span-6"></span>
            </form>
          </div>

          <div class="glass card rounded-2xl p-6">
            <div class="flex items-center justify-between mb-3 gap-2">
              <h4 class="text-lg font-semibold text-primary-800">รายการผู้ใช้</h4>
              <input id="userSearch" class="w-64 max-w-full border border-primary-200 rounded-lg px-3 py-2" placeholder="ค้นหาชื่อหรือผู้ใช้...">
            </div>
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-3" id="userList">
              ${list.map(u => `
                <div class="border border-primary-100 rounded-xl p-4 bg-white" data-user-id="${u.id}">
                  <div class="font-semibold text-primary-900">${u.firstName || ''} ${u.lastName || ''} <span class="text-xs text-slate-500">(${u.username})</span></div>
                  <div class="text-sm text-slate-600 mt-1">สิทธิ์: ${u.role==='admin'?'Admin':'User'}</div>
                  ${u.id.startsWith('seed_') ? `<div class="text-xs text-slate-400 mt-2">บัญชีสำหรับพัฒนาระบบ (แก้ไข/ลบไม่ได้)</div>` : `
                  <div class="flex items-center gap-2 mt-3">
                    <button class="editUser bg-white text-primary-700 border border-primary-200 hover:bg-primary-50 px-3 py-1.5 rounded-lg" data-id="${u.id}">แก้ไข</button>
                    <button class="deleteUser bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded-lg" data-id="${u.id}">ลบ</button>
                  </div>`}
                </div>
              `).join('')}
            </div>
          </div>
        </section>
      `;
    }

    function AddSchoolPage(){
      return `
        <section class="space-y-6">
          <div class="glass card rounded-2xl p-6">
            <h3 class="text-xl font-bold text-primary-800 mb-1">เพิ่มโรงเรียนใหม่</h3>
            <p class="text-xs text-slate-600 mb-3">“ชั้น” เป็นช่องให้พิมพ์เองได้</p>
            <form id="schoolForm" class="grid md:grid-cols-2 gap-4">
              <div class="md:col-span-2">
                <label class="block text-sm mb-1 text-slate-700">ชื่อโรงเรียน</label>
                <input required name="name" class="w-full border border-primary-200 rounded-lg px-3 py-2">
              </div>
              <div>
                <label class="block text-sm mb-1 text-slate-700">จังหวัด</label>
                <input required name="province" class="w-full border border-primary-200 rounded-lg px-3 py-2">
              </div>
              <div>
                <label class="block text-sm mb-1 text-slate-700">ชั้น</label>
                <input required name="level" class="w-full border border-primary-200 rounded-lg px-3 py-2" placeholder="พิมพ์ได้เอง เช่น ป.1-ป.6 หรือ ม.ปลาย">
              </div>
              <div class="md:col-span-2">
                <label class="block text-sm mb-1 text-slate-700">ข้อมูลผู้เพิ่ม (ไม่บังคับ)</label>
                <input name="createdBy" class="w-full border border-primary-200 rounded-lg px-3 py-2" placeholder="เช่น ครูเอ">
              </div>
              <div class="md:col-span-2 flex items-center gap-3">
                <button class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg">เพิ่มโรงเรียน</button>
                <span id="schoolFormMsg" class="text-sm text-slate-600"></span>
              </div>
            </form>
          </div>

          <div class="glass card rounded-2xl p-6">
            <h3 class="text-xl font-bold text-primary-800 mb-4">อัปโหลดรายชื่อโรงเรียนจาก Excel (.xlsx)</h3>
            <div class="flex flex-col sm:flex-row gap-3 sm:items-center">
              <input id="excelInput" type="file" accept=".xlsx" class="w-full sm:w-auto border border-primary-200 rounded-lg px-3 py-2 bg-white">
              <button id="importBtn" class="bg-white text-primary-700 border border-primary-200 hover:bg-primary-50 px-4 py-2 rounded-lg">นำเข้า</button>
              <span id="importMsg" class="text-sm text-slate-600"></span>
            </div>
            <p class="text-xs text-slate-500 mt-3">คอลัมน์ที่รองรับ: name, province, level (หรือ "ชั้น"), createdBy</p>
          </div>

          <div class="glass card rounded-2xl p-6">
            <div class="flex items-center justify-between mb-3 gap-2 flex-wrap">
              <h3 class="text-lg font-semibold text-primary-800">รายการโรงเรียน</h3>
              <input id="schoolSearch" class="w-64 max-w-full border border-primary-200 rounded-lg px-3 py-2" placeholder="ค้นหาโรงเรียน...">
            </div>
            <div id="schoolTable" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
            <div id="schoolEmpty" class="text-slate-500 hidden">ยังไม่มีข้อมูล</div>
          </div>
        </section>
      `;
    }

    function BookingPage(){
      const provinces = Array.from(new Set(schoolListArray().map(s=>s.province).filter(Boolean))).sort((a,b)=>a.localeCompare(b,'th'));
      const myName = displayName(state.user);
      return `
        <section class="space-y-6">
          <div class="glass card rounded-2xl p-6">
            <h3 class="text-xl font-bold text-primary-800 mb-4">การจองโรงเรียน</h3>
            <div class="grid md:grid-cols-4 gap-3">
              <div class="md:col-span-2">
                <input id="searchInput" class="w-full border border-primary-200 rounded-lg px-4 py-2" placeholder="ค้นหาโรงเรียนหรือจังหวัด...">
              </div>
              <div>
                <select id="provinceFilter" class="w-full border border-primary-200 rounded-lg px-4 py-2">
                  <option value="">ทุกจังหวัด</option>
                  ${provinces.map(p=>`<option>${p}</option>`).join('')}
                </select>
              </div>
              <div class="text-sm text-slate-600 flex items-center">
                ผู้ใช้ปัจจุบัน: <span class="ml-1 font-medium">${myName || state.user?.username || '-'}</span>
              </div>
            </div>
          </div>

          <div class="glass card rounded-2xl p-6">
            <div id="schoolList" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            <div id="noResults" class="hidden text-center text-slate-500 py-8">ไม่พบโรงเรียนที่ค้นหา</div>
          </div>
        </section>
      `;
    }

    function MyBookingsPage(){
      const list = myBookingListArray().sort((a,b)=> (new Date(b.datetime||0)) - (new Date(a.datetime||0)));
      return `
        <section class="space-y-6">
          <div class="glass card rounded-2xl p-6">
            <div class="flex items-center justify-between gap-3 flex-wrap">
              <h3 class="text-xl font-bold text-primary-800">การจองของฉัน</h3>
              <input id="myBookingSearch" class="w-64 max-w-full border border-primary-200 rounded-lg px-3 py-2" placeholder="ค้นหาโรงเรียน...">
            </div>
          </div>
          <div class="glass card rounded-2xl overflow-hidden">
            ${list.length ? `
              <div class="overflow-x-auto">
                <table class="w-full">
                  <thead class="bg-primary-50 border-b border-primary-100">
                    <tr>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-primary-800">ชื่อโรงเรียน</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-primary-800">จังหวัด</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-primary-800">ชั้น</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-primary-800">ผู้จอง</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-primary-800">วันเวลา</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-primary-800">การจัดการ</th>
                    </tr>
                  </thead>
                  <tbody id="myBookingList" class="divide-y divide-primary-100">
                    ${list.map((row, index) => MyBookingRow(row, index)).join('')}
                  </tbody>
                </table>
              </div>
            ` : `<div class="p-6 text-slate-500 text-center">ยังไม่มีการจองของคุณ</div>`}
          </div>
        </section>
      `;
    }

    function BookingsListPage(){
      const list = bookingListArray().sort((a,b)=> (new Date(b.datetime||0)) - (new Date(a.datetime||0)));
      return `
        <section class="space-y-6">
          <div class="glass card rounded-2xl p-6">
            <div class="flex items-center justify-between gap-3 flex-wrap">
              <h3 class="text-xl font-bold text-primary-800">รายการจองทั้งหมด</h3>
              <input id="bookingSearch" class="w-64 max-w-full border border-primary-200 rounded-lg px-3 py-2" placeholder="ค้นหาโรงเรียน...">
            </div>
          </div>
          <div class="glass card rounded-2xl overflow-hidden">
            ${list.length ? `
              <div class="overflow-x-auto">
                <table class="w-full">
                  <thead class="bg-primary-50 border-b border-primary-100">
                    <tr>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-primary-800">ชื่อโรงเรียน</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-primary-800">จังหวัด</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-primary-800">ชั้น</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-primary-800">ผู้จอง</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-primary-800">วันเวลา</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-primary-800">จองโดย</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold text-primary-800">การจัดการ</th>
                    </tr>
                  </thead>
                  <tbody id="bookingList" class="divide-y divide-primary-100">
                    ${list.map((row, index) => BookingRow(row, index)).join('')}
                  </tbody>
                </table>
              </div>
            ` : `<div class="p-6 text-slate-500 text-center">ยังไม่มีการจอง</div>`}
          </div>
        </section>
      `;
    }

    function BookingRow(row, bookingIndex){
      const canEdit = isAdmin();
      return `
        <tr class="hover:bg-primary-50" data-row data-name="${row.schoolName.toLowerCase()}">
          <td class="px-4 py-3 font-semibold text-primary-900">${row.schoolName}</td>
          <td class="px-4 py-3 text-slate-600">${row.province}</td>
          <td class="px-4 py-3 text-slate-600">${row.level || '-'}</td>
          <td class="px-4 py-3 text-slate-700">${row.teacher}</td>
          <td class="px-4 py-3 text-slate-600">${fmtDateTime(row.datetime)}</td>
          <td class="px-4 py-3 text-slate-500 text-sm">${row.createdBy || '-'}</td>
          <td class="px-4 py-3">
            <div class="flex items-center gap-2">
              ${canEdit ? `
                <button class="editBooking bg-white text-primary-700 border border-primary-200 hover:bg-primary-50 px-2 py-1 rounded text-sm" data-school-id="${row.schoolId}" data-booking-index="${bookingIndex}">แก้ไข</button>
                <button class="deleteBooking bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-sm" data-school-id="${row.schoolId}" data-booking-index="${bookingIndex}">ลบ</button>
              `:'<span class="text-xs text-slate-400">-</span>'}
            </div>
          </td>
        </tr>
      `;
    }

    function MyBookingRow(row, bookingIndex){
      const canCancel = state.user && row.createdBy === state.user.username;
      return `
        <tr class="hover:bg-primary-50">
          <td class="px-4 py-3 font-semibold text-primary-900">${row.schoolName}</td>
          <td class="px-4 py-3 text-slate-600">${row.province}</td>
          <td class="px-4 py-3 text-slate-600">${row.level || '-'}</td>
          <td class="px-4 py-3 text-slate-700">${row.teacher}</td>
          <td class="px-4 py-3 text-slate-600">${fmtDateTime(row.datetime)}</td>
          <td class="px-4 py-3">
            ${canCancel ? `<button class="cancelMyBooking bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-sm" data-school-id="${row.schoolId}" data-booking-index="${bookingIndex}">ยกเลิก</button>` : `<span class="text-xs text-slate-400">ไม่สามารถยกเลิกได้</span>`}
          </td>
        </tr>
      `;
    }

    // -------------- Render --------------
    function render(){
      if(!state.user){ state.route = 'login'; }
      const body = state.route === 'login' ? LoginPage()
                 : state.route === 'dashboard' ? Dashboard()
                 : state.route === 'add-school' ? AddSchoolPage()
                 : state.route === 'booking' ? BookingPage()
                 : state.route === 'my-bookings' ? MyBookingsPage()
                 : state.route === 'bookings' ? BookingsListPage()
                 : state.route === 'users' ? UsersPage()
                 : LoginPage();

      app.innerHTML = Layout(`
        ${state.loading ? `<div class="mb-4 p-3 rounded-lg bg-primary-50 text-primary-800">กำลังโหลดข้อมูล...</div>`:''}
        ${body}
      `);

      // Nav
      $$('[data-nav]').forEach(btn=>{
        btn.addEventListener('click', (e)=> { e.preventDefault(); navigate(btn.getAttribute('data-nav')); });
      });

      // Logout
      const logoutBtn = $('#logoutBtn');
      if(logoutBtn){
        logoutBtn.addEventListener('click', (e)=>{
          e.preventDefault();
          clearSession();
          state.user = null;
          navigate('login');
        });
      }

      // Route handlers
      if(state.route === 'login'){
        const form = $('#loginForm');
        form.addEventListener('submit', (e)=>{
          e.preventDefault();
          const data = Object.fromEntries(new FormData(form).entries());
          const dbUser = Object.values(state.users||{}).find(u => u.username === data.username && u.password === data.password);
          let account = null;
          if(dbUser){
            account = { username: dbUser.username, role: dbUser.role, firstName: dbUser.firstName, lastName: dbUser.lastName };
          } else {
            const seed = USER_CREDENTIALS.find(u=> u.username === data.username && u.password === data.password);
            if(seed){ account = { username: seed.username, role: seed.role, firstName: seed.firstName, lastName: seed.lastName }; }
          }
          if(account){
            state.user = { ...account, loggedInAt: Date.now() };
            saveSession(state.user);
            state.error = '';
            subscribeData();
            navigate('dashboard');
          } else {
            state.error = 'ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง';
            render();
          }
        });
      }

      if(state.route === 'users' && isAdmin()){
        const addUserForm = $('#addUserForm');
        addUserForm.addEventListener('submit', async (e)=>{
          e.preventDefault();
          const f = Object.fromEntries(new FormData(addUserForm).entries());
          const username = normalizeStr(f.username);
          const exists = usersArray().some(u => u.username === username);
          const msg = $('#addUserMsg');
          if(exists){ msg.textContent = 'มีผู้ใช้นี้อยู่แล้ว'; return; }
          const id = uid();
          await db.ref('users/'+id).set({
            username,
            password: f.password,
            role: f.role,
            firstName: normalizeStr(f.firstName),
            lastName: normalizeStr(f.lastName),
            createdAt: new Date().toISOString()
          });
          addUserForm.reset();
          msg.textContent = 'เพิ่มผู้ใช้เรียบร้อย';
          setTimeout(()=> msg.textContent='', 2000);
        });

        // Search + actions
        const userSearch = $('#userSearch');
        const userListEl = $('#userList');
        function renderUserCards(){
          const q = (userSearch?.value || '').toLowerCase();
          const list = usersArray().filter(u=> !q || `${(u.firstName||'').toLowerCase()} ${(u.lastName||'').toLowerCase()} ${u.username.toLowerCase()}`.includes(q));
          userListEl.innerHTML = list.map(u => `
            <div class="border border-primary-100 rounded-xl p-4 bg-white" data-user-id="${u.id}">
              <div class="font-semibold text-primary-900">${u.firstName || ''} ${u.lastName || ''} <span class="text-xs text-slate-500">(${u.username})</span></div>
              <div class="text-sm text-slate-600 mt-1">สิทธิ์: ${u.role==='admin'?'Admin':'User'}</div>
              ${u.id.startsWith('seed_') ? `<div class="text-xs text-slate-400 mt-2">บัญชีสำหรับการพัฒนาระบบ (แก้ไข/ลบไม่ได้)</div>` : `
              <div class="flex items-center gap-2 mt-3">
                <button class="editUser bg-white text-primary-700 border border-primary-200 hover:bg-primary-50 px-3 py-1.5 rounded-lg" data-id="${u.id}">แก้ไข</button>
                <button class="deleteUser bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded-lg" data-id="${u.id}">ลบ</button>
              </div>`}
            </div>
          `).join('');

          $$('.editUser', userListEl).forEach(btn=> btn.addEventListener('click', ()=> openEditUserModal(btn.getAttribute('data-id'))));
          $$('.deleteUser', userListEl).forEach(btn=> btn.addEventListener('click', ()=> openDeleteUserModal(btn.getAttribute('data-id'))));
        }
        if(userSearch){ userSearch.addEventListener('input', renderUserCards); }
        if(userListEl){ renderUserCards(); }
      }

      if(state.route === 'add-school'){
        const form = $('#schoolForm');
        form.addEventListener('submit', async (e)=>{
          e.preventDefault();
          const f = Object.fromEntries(new FormData(form).entries());
          const name = normalizeStr(f.name);
          const province = normalizeStr(f.province);
          const level = normalizeStr(f.level);
          const existingKeySet = new Set(schoolListArray().map(s => normKeyNameProvince(s.name, s.province)));
          if(existingKeySet.has(normKeyNameProvince(name, province))){
            $('#schoolFormMsg').textContent = 'มีโรงเรียนนี้ในระบบแล้ว (ชื่อ+จังหวัดซ้ำ)';
            return;
          }
          const id = uid();
          const record = {
            name, province, level,
            createdBy: normalizeStr(f.createdBy||state.user.username||''),
            createdAt: new Date().toISOString()
          };
          await db.ref('schools/'+id).set(record);
          e.target.reset();
          const msg = $('#schoolFormMsg'); msg.textContent = 'เพิ่มโรงเรียนเรียบร้อย'; setTimeout(()=> msg.textContent='', 2000);
        });

        // Excel import
        const input = $('#excelInput');
        const importBtn = $('#importBtn');
        importBtn.addEventListener('click', async ()=>{
          const msg = $('#importMsg');
          if(!input.files || !input.files[0]) { msg.textContent = 'กรุณาเลือกไฟล์ .xlsx'; return; }
          msg.textContent = 'กำลังนำเข้า...';
          try {
            const file = input.files[0];
            const data = await file.arrayBuffer();
            const wb = XLSX.read(data, {type:'array'});
            const sheet = wb.Sheets[wb.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(sheet);
            const existingKeySet = new Set(schoolListArray().map(s => normKeyNameProvince(s.name, s.province)));
            const updates = {};
            let added = 0, skipped = 0;
            rows.slice(0, 1000).forEach(r=>{
              const name = normalizeStr(r.name);
              const province = normalizeStr(r.province);
              const level = normalizeStr(r.level || r['ชั้น'] || '');
              if(!name || !province || !level) { skipped++; return; }
              const key = normKeyNameProvince(name, province);
              if(existingKeySet.has(key)){ skipped++; return; }
              existingKeySet.add(key);
              const id = uid();
              updates[id] = {
                name, province, level,
                createdBy: normalizeStr(r.createdBy || state.user.username || ''),
                createdAt: new Date().toISOString()
              };
              added++;
            });
            if(Object.keys(updates).length){ await db.ref('schools').update(updates); }
            msg.textContent = `นำเข้าเรียบร้อย: เพิ่มใหม่ ${added} แถว, ข้าม ${skipped} แถว (ซ้ำ/ข้อมูลไม่ครบ)`;
            setTimeout(()=> msg.textContent='', 4000);
            input.value = '';
          } catch (err){
            console.error(err);
            msg.textContent = 'ไฟล์ไม่ถูกต้อง หรือนำเข้าไม่สำเร็จ';
          }
        });

        // List
        const listEl = $('#schoolTable');
        const emptyEl = $('#schoolEmpty');
        const searchEl = $('#schoolSearch');
        function renderSchools(){
          const q = (searchEl.value||'').toLowerCase();
          const items = schoolListArray()
            .filter(s=> !q || (s.name||'').toLowerCase().includes(q))
            .sort((a,b)=> a.name.localeCompare(b.name,'th'));
          listEl.innerHTML = items.map(s=>{
            const canEdit = isAdmin() || (s.createdBy && s.createdBy===state.user.username);
            const canDelete = isAdmin();
            return `
              <div class="border border-primary-100 rounded-xl p-4 bg-white">
                <div class="font-semibold text-primary-900">${s.name}</div>
                <div class="text-sm text-slate-600 mt-1">จังหวัด: ${s.province} • ชั้น: ${s.level}</div>
                ${s.createdBy ? `<div class="text-xs text-slate-500 mt-1">เพิ่มโดย: ${s.createdBy}</div>`:''}
                <div class="flex items-center gap-2 mt-3">
                  ${canEdit ? `<button class="editSchool bg-white text-primary-700 border border-primary-200 hover:bg-primary-50 px-3 py-1.5 rounded-lg" data-id="${s.id}">แก้ไข</button>`:''}
                  ${canDelete ? `<button class="deleteSchool bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded-lg" data-id="${s.id}">ลบ</button>`:''}
                </div>
              </div>
            `;
          }).join('');
          emptyEl.classList.toggle('hidden', items.length>0);

          $$('.editSchool', listEl).forEach(btn=> btn.addEventListener('click', ()=> openEditSchool(btn.getAttribute('data-id'))));
          $$('.deleteSchool', listEl).forEach(btn=> btn.addEventListener('click', ()=> openDeleteSchool(btn.getAttribute('data-id'))));
        }
        searchEl.addEventListener('input', renderSchools);
        renderSchools();


      }

      if(state.route === 'booking'){
        // Bulk booking functionality
        const bulkBookingBtn = $('#bulkBookingBtn');
        const bulkBookingFile = $('#bulkBookingFile');
        const bulkBookingMsg = $('#bulkBookingMsg');

        if(bulkBookingBtn){
          bulkBookingBtn.addEventListener('click', async ()=>{
            if(!bulkBookingFile.files || !bulkBookingFile.files[0]){
              bulkBookingMsg.textContent = 'กรุณาเลือกไฟล์ .xlsx';
              return;
            }

            bulkBookingMsg.textContent = 'กำลังประมวลผล...';
            try {
              const file = bulkBookingFile.files[0];
              const data = await file.arrayBuffer();
              const wb = XLSX.read(data, {type:'array'});
              const sheet = wb.Sheets[wb.SheetNames[0]];
              const rows = XLSX.utils.sheet_to_json(sheet);

              const existingSchoolKeys = new Set(schoolListArray().map(s => normKeyNameProvince(s.name, s.province)));
              const schoolUpdates = {};
              const bookingUpdates = {};
              let schoolsAdded = 0, bookingsAdded = 0, skipped = 0;

              for(const row of rows.slice(0, 500)){ // Limit to 500 rows
                const name = normalizeStr(row.name);
                const province = normalizeStr(row.province);
                const level = normalizeStr(row.level || row['ชั้น'] || '');
                const teacher = normalizeStr(row.teacher || displayName(state.user) || state.user.username);
                const datetime = row.datetime;

                if(!name || !province || !datetime){
                  skipped++;
                  continue;
                }

                const schoolKey = normKeyNameProvince(name, province);
                let schoolId = null;

                // Find existing school
                const existingSchool = schoolListArray().find(s => normKeyNameProvince(s.name, s.province) === schoolKey);
                if(existingSchool){
                  schoolId = existingSchool.id;
                } else {
                  // Add new school
                  schoolId = uid();
                  schoolUpdates[schoolId] = {
                    name, province, level,
                    createdBy: state.user.username,
                    createdAt: new Date().toISOString()
                  };
                  existingSchoolKeys.add(schoolKey);
                  schoolsAdded++;
                }

                // Check if already booked
                if(state.bookings[schoolId]){
                  skipped++;
                  continue;
                }

                // Add booking
                bookingUpdates[schoolId] = {
                  teacher,
                  datetime,
                  createdBy: state.user.username,
                  createdAt: new Date().toISOString()
                };
                bookingsAdded++;
              }

              // Save to Firebase
              if(Object.keys(schoolUpdates).length > 0){
                await db.ref('schools').update(schoolUpdates);
              }
              if(Object.keys(bookingUpdates).length > 0){
                await db.ref('bookings').update(bookingUpdates);
              }

              bulkBookingMsg.textContent = `สำเร็จ! เพิ่มโรงเรียนใหม่ ${schoolsAdded} แห่ง, จองโรงเรียน ${bookingsAdded} แห่ง, ข้าม ${skipped} แถว`;
              bulkBookingFile.value = '';
              setTimeout(()=> bulkBookingMsg.textContent = '', 5000);

            } catch(err){
              console.error(err);
              bulkBookingMsg.textContent = 'เกิดข้อผิดพลาดในการประมวลผลไฟล์';
            }
          });
        }

        // Individual booking functionality
        const searchInput = $('#searchInput');
        const provinceFilter = $('#provinceFilter');
        const schoolListEl = $('#schoolList');
        const noResultsEl = $('#noResults');

        function updateList(){
          const list = schoolListArray(); // Show all schools now
          const query = (searchInput.value || '').trim();
          const province = provinceFilter.value || '';

          const options = { keys: ['name','province','level'], threshold: 0.35, ignoreLocation: true, includeScore: true, minMatchCharLength: 2 };
          let filtered = list;
          if(query){
            const fuse = new Fuse(list.map(s=>({
              ...s,
              name: normalizeStr((s.name||'').replace(/\s+/g,' ')),
              province: normalizeStr(s.province||''),
              level: normalizeStr(s.level||'')
            })), options);
            filtered = fuse.search(normalizeStr(query)).map(r=>r.item);
          }
          if(province) filtered = filtered.filter(s=> (s.province||'') === province);

          schoolListEl.innerHTML = filtered.slice(0, 60).map(s=>{
            const existingBookings = getSchoolBookings(s.id);
            const hasBookings = existingBookings.length > 0;
            
            return `
              <div class="border border-primary-100 rounded-xl p-4 bg-white fade-enter">
                <div class="flex items-start justify-between gap-2">
                  <div>
                    <div class="font-semibold text-primary-900">${s.name}</div>
                    <div class="text-sm text-slate-600 mt-1">จังหวัด: ${s.province} • ชั้น: ${s.level}</div>
                    ${hasBookings ? `
                      <div class="text-xs text-orange-600 mt-2 space-y-1">
                        <div class="font-medium">ถูกจองแล้ว:</div>
                        ${existingBookings.slice(0, 3).map(b => `
                          <div>• ${b.teacher} - ${fmtDateTime(b.datetime)}</div>
                        `).join('')}
                        ${existingBookings.length > 3 ? `<div>และอีก ${existingBookings.length - 3} การจอง...</div>` : ''}
                      </div>
                    ` : ''}
                  </div>
                  <span class="tag text-xs ${hasBookings ? 'text-orange-700 bg-orange-50' : 'text-green-700 bg-green-50'} px-2 py-1 rounded">
                    ${hasBookings ? 'มีการจอง' : 'ว่าง'}
                  </span>
                </div>
                <form class="bookingForm mt-3 space-y-2" data-id="${s.id}">
                  <div>
                    <label class="block text-xs text-slate-600 mb-1">ชื่ออาจารย์ผู้จอง</label>
                    <input name="teacher" class="w-full border border-primary-200 rounded-lg px-3 py-2" placeholder="ถ้าเว้นว่าง ระบบจะใช้ชื่อ-นามสกุลจริงของคุณ">
                    <p class="text-xs text-slate-500 mt-1">คำแนะนำ: ปล่อยว่างเพื่อใช้ชื่อจริงของคุณอัตโนมัติ</p>
                  </div>
                  <div>
                    <label class="block text-xs text-slate-600 mb-1">วัน เวลา ${hasBookings ? '(ห้ามซ้ำเวลาที่มีอยู่)' : ''}</label>
                    <input name="datetime" type="datetime-local" required class="w-full border border-primary-200 rounded-lg px-3 py-2">
                  </div>
                  <button class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg">จองโรงเรียนนี้</button>
                  <span class="text-sm text-slate-600 formMsg"></span>
                </form>
              </div>
            `;
          }).join('');

          requestAnimationFrame(()=>{
            $$('.fade-enter', schoolListEl).forEach(el=> {
              el.classList.add('fade-enter-active');
              setTimeout(()=> el.classList.remove('fade-enter','fade-enter-active'), 250);
            });
          });

          noResultsEl.classList.toggle('hidden', filtered.length>0);

          // Booking handler
          $$('.bookingForm', schoolListEl).forEach(form=>{
            form.addEventListener('submit', async (e)=>{
              e.preventDefault();
              const id = form.getAttribute('data-id');
              const data = Object.fromEntries(new FormData(form).entries());
              const msg = $('.formMsg', form);
              
              // Check for duplicate datetime
              const existingBookings = getSchoolBookings(id);
              const newDateTime = data.datetime;
              const isDuplicate = existingBookings.some(b => b.datetime === newDateTime);
              
              if(isDuplicate){
                showDuplicateBookingModal();
                return;
              }
              
              const teacherInput = normalizeStr(data.teacher || '');
              const teacherName = teacherInput || displayName(state.user) || state.user.username;
              
              // Add new booking to array
              const newBooking = {
                teacher: teacherName,
                datetime: data.datetime,
                createdBy: state.user.username,
                createdAt: new Date().toISOString()
              };
              
              const currentBookings = getSchoolBookings(id);
              const updatedBookings = [...currentBookings, newBooking];
              
              await db.ref('bookings/'+id).set(updatedBookings);
              
              msg.textContent = 'จองสำเร็จ';
              msg.className = 'text-sm text-green-600 formMsg';
              form.reset();
              setTimeout(()=> {
                msg.textContent = '';
                msg.className = 'text-sm text-slate-600 formMsg';
                updateList(); // Refresh the list to show updated bookings
              }, 1500);
            });
          });
        }

        searchInput.addEventListener('input', ()=> updateList());
        provinceFilter.addEventListener('change', ()=> updateList());
        updateList();
      }

      if(state.route === 'my-bookings'){
        const searchEl = $('#myBookingSearch');
        const listEl = $('#myBookingList');
        function renderRows(){
          const q = (searchEl.value || '').toLowerCase();
          const filteredList = myBookingListArray()
            .filter(r=> !q || r.schoolName.toLowerCase().includes(q))
            .sort((a,b)=> (new Date(b.datetime||0)) - (new Date(a.datetime||0)));
          
          if(filteredList.length === 0){
            listEl.closest('.glass').innerHTML = `<div class="p-6 text-slate-500 text-center">ไม่พบผลลัพธ์</div>`;
            return;
          }
          
          const tableHTML = `
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-primary-50 border-b border-primary-100">
                  <tr>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-primary-800">ชื่อโรงเรียน</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-primary-800">จังหวัด</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-primary-800">ชั้น</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-primary-800">ผู้จอง</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-primary-800">วันเวลา</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-primary-800">การจัดการ</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-primary-100">
                  ${filteredList.map((r, index)=> MyBookingRow(r, index)).join('')}
                </tbody>
              </table>
            </div>
          `;
          
          listEl.closest('.glass').innerHTML = tableHTML;
          
          $$('.cancelMyBooking').forEach(btn=>{
            btn.addEventListener('click', ()=> openCancelMyBookingModal(btn.getAttribute('data-school-id'), btn.getAttribute('data-booking-index')));
          });
        }
        searchEl.addEventListener('input', renderRows);
        renderRows();


      }

      if(state.route === 'bookings'){
        const bookingSearch = $('#bookingSearch');
        const listEl = $('#bookingList');
        function renderRows(){
          const q = (bookingSearch.value || '').toLowerCase();
          const filteredList = bookingListArray()
            .filter(r=> !q || r.schoolName.toLowerCase().includes(q))
            .sort((a,b)=> (new Date(b.datetime||0)) - (new Date(a.datetime||0)));
          
          if(filteredList.length === 0){
            listEl.closest('.glass').innerHTML = `<div class="p-6 text-slate-500 text-center">ไม่พบผลลัพธ์</div>`;
            return;
          }
          
          const tableHTML = `
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-primary-50 border-b border-primary-100">
                  <tr>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-primary-800">ชื่อโรงเรียน</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-primary-800">จังหวัด</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-primary-800">ชั้น</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-primary-800">ผู้จอง</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-primary-800">วันเวลา</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-primary-800">จองโดย</th>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-primary-800">การจัดการ</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-primary-100">
                  ${filteredList.map((r, index)=> BookingRow(r, index)).join('')}
                </tbody>
              </table>
            </div>
          `;
          
          listEl.closest('.glass').innerHTML = tableHTML;

          if(isAdmin()){
            $$('.editBooking').forEach(btn=>{
              btn.addEventListener('click', ()=> openEditBookingModal(btn.getAttribute('data-school-id'), btn.getAttribute('data-booking-index')));
            });
            $$('.deleteBooking').forEach(btn=>{
              btn.addEventListener('click', ()=> openDeleteBookingModal(btn.getAttribute('data-school-id'), btn.getAttribute('data-booking-index')));
            });
          }
        }
        bookingSearch.addEventListener('input', renderRows);
        renderRows();


      }


    }

    // -------------- Modals: Duplicate Booking --------------
    function showDuplicateBookingModal(){
      const modal = document.createElement('div');
      modal.className = "fixed inset-0 z-50 flex items-center justify-center";
      modal.innerHTML = `
        <div class="absolute inset-0 bg-black/40"></div>
        <div class="relative glass card rounded-2xl p-6 w-[95%] max-w-md z-10 border-2 border-orange-200">
          <div class="text-center">
            <div class="w-16 h-16 mx-auto mb-4 bg-orange-100 rounded-full flex items-center justify-center">
              <svg class="w-8 h-8 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
              </svg>
            </div>
            <h3 class="text-xl font-bold text-orange-800 mb-2">มีการจองซ้ำ</h3>
            <p class="text-slate-700 mb-6 leading-relaxed">
              เวลาที่คุณเลือกมีการจองแล้ว<br>
              <span class="font-semibold text-orange-700">ท่านสามารถจองในเวลาอื่นได้</span>
            </p>
            <button id="closeDuplicateModal" class="bg-primary-600 hover:bg-primary-700 text-white px-6 py-2.5 rounded-lg font-medium">
              เข้าใจแล้ว
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      
      $('#closeDuplicateModal', modal).addEventListener('click', ()=> {
        modal.remove();
      });
      
      // Auto close after 5 seconds
      setTimeout(()=> {
        if(document.body.contains(modal)){
          modal.remove();
        }
      }, 5000);
    }

    // -------------- Modals: Users --------------
    function openEditUserModal(userId){
      const user = usersArray().find(u => u.id === userId);
      if(!user || user.id.startsWith('seed_')) return;
      
      const modal = document.createElement('div');
      modal.className = "fixed inset-0 z-40 flex items-center justify-center";
      modal.innerHTML = `
        <div class="absolute inset-0 bg-black/30"></div>
        <div class="relative glass card rounded-2xl p-6 w-[95%] max-w-md z-10">
          <h3 class="text-lg font-bold text-primary-800 mb-2">แก้ไขข้อมูลผู้ใช้</h3>
          <form id="editUserForm" class="space-y-3">
            <div>
              <label class="block text-sm mb-1 text-slate-700">ชื่อผู้ใช้</label>
              <input name="username" required class="w-full border border-primary-200 rounded-lg px-3 py-2" value="${user.username}">
            </div>
            <div>
              <label class="block text-sm mb-1 text-slate-700">รหัสผ่าน</label>
              <input name="password" type="password" required class="w-full border border-primary-200 rounded-lg px-3 py-2" value="${user.password || ''}">
            </div>
            <div>
              <label class="block text-sm mb-1 text-slate-700">ชื่อ</label>
              <input name="firstName" required class="w-full border border-primary-200 rounded-lg px-3 py-2" value="${user.firstName || ''}">
            </div>
            <div>
              <label class="block text-sm mb-1 text-slate-700">นามสกุล</label>
              <input name="lastName" required class="w-full border border-primary-200 rounded-lg px-3 py-2" value="${user.lastName || ''}">
            </div>
            <div>
              <label class="block text-sm mb-1 text-slate-700">สิทธิ์</label>
              <select name="role" class="w-full border border-primary-200 rounded-lg px-3 py-2">
                <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
              </select>
            </div>
            <div class="flex items-center gap-2">
              <button class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg">บันทึก</button>
              <button type="button" id="closeEditUser" class="bg-white text-primary-700 border border-primary-200 hover:bg-primary-50 px-4 py-2 rounded-lg">ยกเลิก</button>
              <span id="editUserMsg" class="text-sm text-slate-600"></span>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);
      $('#closeEditUser', modal).addEventListener('click', ()=> modal.remove());
      $('#editUserForm', modal).addEventListener('submit', async (e)=>{
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target).entries());
        
        // Check if username already exists (excluding current user)
        const existingUser = usersArray().find(u => u.username === data.username && u.id !== userId);
        if(existingUser){
          $('#editUserMsg', modal).textContent = 'ชื่อผู้ใช้นี้มีอยู่แล้ว';
          $('#editUserMsg', modal).className = 'text-sm text-red-600';
          return;
        }
        
        await db.ref('users/'+userId).update({
          username: normalizeStr(data.username),
          password: data.password,
          firstName: normalizeStr(data.firstName),
          lastName: normalizeStr(data.lastName),
          role: data.role
        });
        $('#editUserMsg', modal).textContent = 'บันทึกแล้ว';
        $('#editUserMsg', modal).className = 'text-sm text-green-600';
        setTimeout(()=> modal.remove(), 800);
      });
    }

    function openDeleteUserModal(userId){
      const user = usersArray().find(u => u.id === userId);
      if(!user || user.id.startsWith('seed_')) return;
      
      const modal = document.createElement('div');
      modal.className = "fixed inset-0 z-40 flex items-center justify-center";
      modal.innerHTML = `
        <div class="absolute inset-0 bg-black/30"></div>
        <div class="relative glass card rounded-2xl p-6 w-[95%] max-w-md z-10">
          <h3 class="text-lg font-bold text-red-700 mb-2">ยืนยันการลบผู้ใช้</h3>
          <p class="text-slate-700 mb-4">ลบผู้ใช้ <span class="font-semibold">${user.firstName} ${user.lastName} (${user.username})</span> ใช่หรือไม่?</p>
          <div class="flex items-center gap-2">
            <button id="confirmDeleteUser" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">ลบ</button>
            <button id="cancelDeleteUser" class="bg-white text-primary-700 border border-primary-200 hover:bg-primary-50 px-4 py-2 rounded-lg">ยกเลิก</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      $('#cancelDeleteUser', modal).addEventListener('click', ()=> modal.remove());
      $('#confirmDeleteUser', modal).addEventListener('click', async ()=>{
        await db.ref('users/'+userId).remove();
        modal.remove();
      });
    }

    // -------------- Modals: Schools --------------
    function openEditSchool(schoolId){
      const s = state.schools[schoolId];
      const modal = document.createElement('div');
      modal.className = "fixed inset-0 z-40 flex items-center justify-center";
      modal.innerHTML = `
        <div class="absolute inset-0 bg-black/30"></div>
        <div class="relative glass card rounded-2xl p-6 w-[95%] max-w-md z-10">
          <h3 class="text-lg font-bold text-primary-800 mb-2">แก้ไขข้อมูลโรงเรียน</h3>
          <form id="editSchoolForm" class="space-y-3">
            <div>
              <label class="block text-sm mb-1 text-slate-700">ชื่อโรงเรียน</label>
              <input name="name" required class="w-full border border-primary-200 rounded-lg px-3 py-2" value="${s.name}">
            </div>
            <div>
              <label class="block text-sm mb-1 text-slate-700">จังหวัด</label>
              <input name="province" required class="w-full border border-primary-200 rounded-lg px-3 py-2" value="${s.province}">
            </div>
            <div>
              <label class="block text-sm mb-1 text-slate-700">ชั้น</label>
              <input name="level" required class="w-full border border-primary-200 rounded-lg px-3 py-2" value="${s.level || ''}" placeholder="พิมพ์ชั้นได้เอง">
            </div>
            <div class="flex items-center gap-2">
              <button class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg">บันทึก</button>
              <button type="button" id="closeEditSchool" class="bg-white text-primary-700 border border-primary-200 hover:bg-primary-50 px-4 py-2 rounded-lg">ยกเลิก</button>
              <span id="editSchoolMsg" class="text-sm text-slate-600"></span>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);
      $('#closeEditSchool', modal).addEventListener('click', ()=> modal.remove());
      $('#editSchoolForm', modal).addEventListener('submit', async (e)=>{
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target).entries());
        await db.ref('schools/'+schoolId).update({
          name: normalizeStr(data.name),
          province: normalizeStr(data.province),
          level: normalizeStr(data.level)
        });
        $('#editSchoolMsg', modal).textContent = 'บันทึกแล้ว';
        setTimeout(()=> modal.remove(), 400);
      });
    }
    function openDeleteSchool(schoolId){
      const s = state.schools[schoolId];
      const modal = document.createElement('div');
      modal.className = "fixed inset-0 z-40 flex items-center justify-center";
      modal.innerHTML = `
        <div class="absolute inset-0 bg-black/30"></div>
        <div class="relative glass card rounded-2xl p-6 w-[95%] max-w-md z-10">
          <h3 class="text-lg font-bold text-red-700 mb-2">ยืนยันการลบโรงเรียน</h3>
          <p class="text-slate-700 mb-4">ลบโรงเรียน <span class="font-semibold">${s.name}</span> ใช่หรือไม่?</p>
          <div class="flex items-center gap-2">
            <button id="confirmDeleteSchool" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">ลบ</button>
            <button id="cancelDeleteSchool" class="bg-white text-primary-700 border border-primary-200 hover:bg-primary-50 px-4 py-2 rounded-lg">ยกเลิก</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      $('#cancelDeleteSchool', modal).addEventListener('click', ()=> modal.remove());
      $('#confirmDeleteSchool', modal).addEventListener('click', async ()=>{
        if(!isAdmin()){ alert('เฉพาะผู้ดูแลระบบเท่านั้นที่ลบได้'); return; }
        await db.ref('schools/'+schoolId).remove();
        if(state.bookings[schoolId]){ await db.ref('bookings/'+schoolId).remove(); }
        modal.remove();
      });
    }

    // -------------- Modals: Bookings --------------
    function openEditBookingModal(schoolId, bookingIndex){
      const bookings = getSchoolBookings(schoolId);
      const booking = bookings[parseInt(bookingIndex)];
      const school = state.schools[schoolId] || {};
      if(!booking) return;
      
      const modal = document.createElement('div');
      modal.className = "fixed inset-0 z-40 flex items-center justify-center";
      modal.innerHTML = `
        <div class="absolute inset-0 bg-black/30"></div>
        <div class="relative glass card rounded-2xl p-6 w-[95%] max-w-md z-10">
          <h3 class="text-lg font-bold text-primary-800 mb-2">แก้ไขการจอง</h3>
          <div class="text-sm text-slate-600 mb-4">${school.name || 'โรงเรียน'}</div>
          <form id="editForm" class="space-y-3">
            <div>
              <label class="block text-sm mb-1 text-slate-700">ผู้จอง</label>
              <input name="teacher" required class="w-full border border-primary-200 rounded-lg px-3 py-2" value="${booking.teacher || ''}">
            </div>
            <div>
              <label class="block text-sm mb-1 text-slate-700">วัน เวลา</label>
              <input name="datetime" type="datetime-local" required class="w-full border border-primary-200 rounded-lg px-3 py-2" value="${toLocalInput(booking.datetime)}">
            </div>
            <div class="flex items-center gap-2">
              <button class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg">บันทึก</button>
              <button type="button" id="closeEdit" class="bg-white text-primary-700 border border-primary-200 hover:bg-primary-50 px-4 py-2 rounded-lg">ยกเลิก</button>
              <span id="editMsg" class="text-sm text-slate-600"></span>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);
      $('#closeEdit', modal).addEventListener('click', ()=> modal.remove());
      $('#editForm', modal).addEventListener('submit', async (e)=>{
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target).entries());
        
        // Update specific booking in array
        const updatedBookings = [...bookings];
        updatedBookings[parseInt(bookingIndex)] = {
          ...booking,
          teacher: normalizeStr(data.teacher),
          datetime: data.datetime
        };
        
        await db.ref('bookings/'+schoolId).set(updatedBookings);
        $('#editMsg', modal).textContent = 'บันทึกแล้ว';
        setTimeout(()=> modal.remove(), 400);
      });
    }
    
    function openDeleteBookingModal(schoolId, bookingIndex){
      const bookings = getSchoolBookings(schoolId);
      const booking = bookings[parseInt(bookingIndex)];
      const school = state.schools[schoolId] || {};
      if(!booking) return;
      
      const modal = document.createElement('div');
      modal.className = "fixed inset-0 z-40 flex items-center justify-center";
      modal.innerHTML = `
        <div class="absolute inset-0 bg-black/30"></div>
        <div class="relative glass card rounded-2xl p-6 w-[95%] max-w-md z-10">
          <h3 class="text-lg font-bold text-red-700 mb-2">ยืนยันการลบ</h3>
          <p class="text-slate-700 mb-4">ลบการจองของ <span class="font-semibold">${school.name || 'โรงเรียน'}</span><br>
          ผู้จอง: ${booking.teacher} • ${fmtDateTime(booking.datetime)}</p>
          <div class="flex items-center gap-2">
            <button id="confirmDelete" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">ลบ</button>
            <button id="cancelDelete" class="bg-white text-primary-700 border border-primary-200 hover:bg-primary-50 px-4 py-2 rounded-lg">ยกเลิก</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      $('#cancelDelete', modal).addEventListener('click', ()=> modal.remove());
      $('#confirmDelete', modal).addEventListener('click', async ()=>{
        // Remove specific booking from array
        const updatedBookings = bookings.filter((_, index) => index !== parseInt(bookingIndex));
        
        if(updatedBookings.length === 0){
          await db.ref('bookings/'+schoolId).remove();
        } else {
          await db.ref('bookings/'+schoolId).set(updatedBookings);
        }
        modal.remove();
      });
    }
    
    function openCancelMyBookingModal(schoolId, bookingIndex){
      const bookings = getSchoolBookings(schoolId);
      const booking = bookings[parseInt(bookingIndex)];
      const school = state.schools[schoolId] || {};
      if(!booking) return;
      
      const isOwner = booking.createdBy === (state.user?.username || '');
      if(!isOwner){ alert('คุณสามารถยกเลิกเฉพาะการจองของตัวเองเท่านั้น'); return; }
      
      const modal = document.createElement('div');
      modal.className = "fixed inset-0 z-40 flex items-center justify-center";
      modal.innerHTML = `
        <div class="absolute inset-0 bg-black/30"></div>
        <div class="relative glass card rounded-2xl p-6 w-[95%] max-w-md z-10">
          <h3 class="text-lg font-bold text-red-700 mb-2">ยกเลิกการจอง</h3>
          <p class="text-slate-700 mb-4">ยืนยันยกเลิกการจองของ <span class="font-semibold">${school.name || 'โรงเรียน'}</span><br>
          ผู้จอง: ${booking.teacher} • ${fmtDateTime(booking.datetime)}</p>
          <div class="flex items-center gap-2">
            <button id="confirmCancelMine" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">ยกเลิก</button>
            <button id="cancelCancelMine" class="bg-white text-primary-700 border border-primary-200 hover:bg-primary-50 px-4 py-2 rounded-lg">ปิด</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      $('#cancelCancelMine', modal).addEventListener('click', ()=> modal.remove());
      $('#confirmCancelMine', modal).addEventListener('click', async ()=>{
        // Remove specific booking from array
        const updatedBookings = bookings.filter((_, index) => index !== parseInt(bookingIndex));
        
        if(updatedBookings.length === 0){
          await db.ref('bookings/'+schoolId).remove();
        } else {
          await db.ref('bookings/'+schoolId).set(updatedBookings);
        }
        modal.remove();
        navigate('my-bookings');
      });
    }



    // -------------- Utils --------------
    function toLocalInput(iso){
      try {
        const d = new Date(iso);
        if (isNaN(d.getTime())) return '';
        const pad = n=> String(n).padStart(2,'0');
        const yyyy = d.getFullYear();
        const mm = pad(d.getMonth()+1);
        const dd = pad(d.getDate());
        const hh = pad(d.getHours());
        const mi = pad(d.getMinutes());
        return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
      } catch { return ''; }
    }

    // -------------- Boot --------------
    (function init(){
      const session = loadSession();
      if(session){
        state.user = session;
        subscribeData();
        navigate('dashboard');
      } else {
        navigate('login');
        subscribeData();
      }
    })();
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9817889c522e1d37',t:'MTc1ODI2ODY2MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
